<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mister 2.0 – Planner Allenamenti</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f6f7f4;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            color: #0aa85e;
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .header .subtitle {
            color: #666;
            font-size: 0.9rem;
            font-style: italic;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        .form-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .form-section h2 {
            color: #0aa85e;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #0aa85e;
            box-shadow: 0 0 0 3px rgba(10, 168, 94, 0.1);
        }
        
        .phases-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .phase {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #fafafa;
        }
        
        .phase-header {
            font-weight: 600;
            color: #0aa85e;
            margin-bottom: 10px;
        }
        
        .phase select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .phase select:focus {
            outline: none;
            border-color: #0aa85e;
            box-shadow: 0 0 0 3px rgba(10, 168, 94, 0.1);
        }
        
        .exercise-details {
            background: white;
            padding: 12px;
            border-radius: 6px;
            margin-top: 10px;
            border-left: 4px solid #0aa85e;
        }
        
        .exercise-desc {
            margin-bottom: 8px;
            color: #555;
        }
        
        .exercise-mats {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        
        .mat-chip {
            background: #0aa85e;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .custom-form {
            background: #fff;
            border: 2px solid #0aa85e;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            display: none;
        }
        
        .custom-form.active {
            display: block;
        }
        
        .custom-form h4 {
            color: #0aa85e;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }
        
        .custom-form .form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }
        
        .custom-form .form-group input,
        .custom-form .form-group textarea {
            font-size: 13px;
        }
        
        .materials-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .material-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f9f9f9;
            padding: 8px;
            border-radius: 6px;
        }
        
        .material-item label {
            font-size: 12px;
            font-weight: 500;
            min-width: 80px;
        }
        
        .material-item input {
            width: 50px;
            padding: 4px;
            font-size: 12px;
            text-align: center;
        }
        
        .custom-form-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .btn-small.primary {
            background: #0aa85e;
            color: white;
        }
        
        .btn-small.secondary {
            background: #f0f0f0;
            color: #333;
            border: 1px solid #ddd;
        }
        
        .sidebar {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            height: fit-content;
            position: sticky;
            top: 20px;
        }
        
        .sidebar h3 {
            color: #0aa85e;
            margin-bottom: 15px;
        }
        
        .total-materials {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .total-chip {
            background: #f0f0f0;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 13px;
            border: 1px solid #ddd;
        }
        
        .button-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .btn {
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            text-align: center;
            text-decoration: none;
        }
        
        .btn-primary {
            background: #0aa85e;
            color: white;
        }
        
        .btn-primary:hover {
            background: #099450;
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
            border: 1px solid #ddd;
        }
        
        .btn-secondary:hover {
            background: #e0e0e0;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-whatsapp {
            background: #25d366;
            color: white;
        }
        
        .btn-whatsapp:hover {
            background: #20b358;
        }
        
        .footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: #666;
            font-size: 0.9rem;
        }
        
        .guide-text {
            color: #999;
            font-style: italic;
            padding: 20px;
            text-align: center;
        }
        
        .required {
            color: #dc3545;
        }
        
        .validity-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .validity-incomplete {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .validity-complete {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .custom-exercise-badge {
            background: #ff6b6b;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 500;
            margin-left: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Mister 2.0 – Planner Allenamenti</h1>
            <div class="subtitle">by 2M Digital Consulting srls</div>
        </div>
        
        <div class="main-content">
            <div class="left-column">
                <div class="form-section">
                    <h2>Dati Allenamento</h2>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="presenti">Numero presenti <span class="required">*</span></label>
                            <select id="presenti" required>
                                <option value="4">4 giocatori</option>
                                <option value="5">5 giocatori</option>
                                <option value="6">6 giocatori</option>
                                <option value="7">7 giocatori</option>
                                <option value="8">8 giocatori</option>
                                <option value="9">9 giocatori</option>
                                <option value="10">10 giocatori</option>
                                <option value="11">11 giocatori</option>
                                <option value="12" selected>12 giocatori</option>
                                <option value="13">13 giocatori</option>
                                <option value="14">14 giocatori</option>
                                <option value="15">15 giocatori</option>
                                <option value="16">16 giocatori</option>
                                <option value="17">17 giocatori</option>
                                <option value="18">18 giocatori</option>
                                <option value="19">19 giocatori</option>
                                <option value="20">20 giocatori</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="data">Data</label>
                            <input type="date" id="data">
                        </div>
                        <div class="form-group">
                            <label for="ora">Ora</label>
                            <input type="time" id="ora" value="17:00">
                        </div>
                        <div class="form-group">
                            <label for="campo">Campo</label>
                            <input type="text" id="campo" placeholder="es. Campo A">
                        </div>
                        <div class="form-group">
                            <label for="mister">Mister</label>
                            <input type="text" id="mister" placeholder="Nome allenatore">
                        </div>
                        <div class="form-group">
                            <label for="categoria">Categoria</label>
                            <select id="categoria">
                                <option value="Primi Calci">Primi Calci</option>
                                <option value="Pulcini">Pulcini</option>
                                <option value="Esordienti" selected>Esordienti</option>
                                <option value="Giovanissimi">Giovanissimi</option>
                                <option value="Allievi">Allievi</option>
                                <option value="Juniores">Juniores</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group" style="margin-top: 15px;">
                        <label for="note">Note</label>
                        <textarea id="note" rows="3" placeholder="Note aggiuntive per l'allenamento"></textarea>
                    </div>
                </div>
                
                <div class="phases-section">
                    <h2>Fasi Allenamento</h2>
                    <div style="margin-bottom: 15px;">
                        <span id="validity-status" class="validity-status validity-incomplete">0/6 esercizi selezionati</span>
                    </div>
                    <div id="phases-container"></div>
                </div>
            </div>
            
            <div class="sidebar">
                <h3>Materiale Totale</h3>
                <div id="total-materials" class="total-materials">
                    <div class="guide-text">Seleziona gli esercizi per vedere il materiale necessario</div>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-secondary" onclick="autofillExercises()">Suggerisci set completo</button>
                    <button class="btn btn-danger" onclick="clearSelections()">Svuota selezioni</button>
                    <button class="btn btn-secondary" onclick="saveToMemory()">Salva temporaneo</button>
                    <button class="btn btn-secondary" onclick="loadFromMemory()">Carica temporaneo</button>
                    <button class="btn btn-primary" onclick="exportPDF()">Esporta PDF</button>
                    <button class="btn btn-whatsapp" onclick="shareWhatsApp()">Invia su WhatsApp</button>
                </div>
            </div>
        </div>
        
        <div class="footer">
            © <span id="year"></span> Mister 2.0 – Planner Allenamenti by 2M Digital Consulting srls
        </div>
    </div>

    <script>
        // Database esercizi
        const DB = {
            attivazione: [
                {id:'att1', name:'Corsa libera con cambi direzione al fischio', min:4, max:20, desc:'Corsa libera in spazio delimitato; al fischio cambio direzione o gesto tecnico.', mats:{fischietto:1, cinesini:8}},
                {id:'att2', name:'Staffetta a squadre con conduzione palla', min:6, max:20, desc:'Squadre in file: guida palla, gira il cono e rientra, tocca il compagno.', mats:{palloni:'per_giocatore', cinesini:12}},
                {id:'att3', name:'Gioco del "colpisci il cono"', min:4, max:20, desc:'Tiro di precisione su conetti a distanza crescente correndo.', mats:{palloni:3, conetti:12}},
                {id:'att4', name:'Quadrato coordinativo', min:4, max:20, desc:'Skip, balzi, scatti sui 4 lati del quadrato coordinativo.', mats:{cinesini:16}},
                {id:'att5', name:'Rubapalla (tutti con palla)', min:4, max:20, desc:'Ognuno guida la propria palla proteggendola, rubando quella degli altri.', mats:{palloni:'per_giocatore', cinesini:8}},
                {id:'att6', name:'Corsa a coppie legati per mano', min:4, max:20, desc:'A coppie, corsa sincronizzata con cambi ritmo/direzione.', mats:{cinesini:8}},
                {id:'att7', name:'Slalom tra conetti a tempo', min:4, max:20, desc:'Slalom tra conetti, sfida a tempo.', mats:{conetti:12, cronometro:1}},
                {id:'att8', name:'Chi ha la palla?', min:5, max:20, desc:'Un pallone in meno dei giocatori: chi resta senza corre a recuperarne uno.', mats:{palloni:'giocatori_meno_1', cinesini:6}},
                {id:'att9', name:'Circuito motorio', min:4, max:20, desc:'Stazioni: corsa, saltelli, scatti brevi.', mats:{cinesini:12}},
                {id:'att10', name:'Conduzione con cambio piede/direzione', min:4, max:20, desc:'Guida palla e cambia piede/direzione a comando del mister.', mats:{palloni:'per_giocatore', fischietto:1, cinesini:10}}
            ],
            tecnica: [
                {id:'tec1', name:'Passaggi a coppie con stop orientato', min:4, max:20, desc:'A coppie: controllo orientato e passaggio preciso.', mats:{palloni:'per_coppia', cinesini:8}},
                {id:'tec2', name:'Triangoli di passaggio con movimento', min:6, max:20, desc:'Sequenze a 3 con movimento continuo e rotazione.', mats:{palloni:2, cinesini:12}},
                {id:'tec3', name:'Guida palla tra ostacoli + tiro finale', min:4, max:20, desc:'Slalom e conclusione su porticine o porte.', mats:{palloni:'per_giocatore', conetti:12, porticine:2}},
                {id:'tec4', name:'1 vs 1 a porte piccole', min:4, max:20, desc:'Duelli rapidi con tante ripetizioni su porte ridotte.', mats:{palloni:2, porticine:2, cinesini:8}},
                {id:'tec5', name:'Conduzione su comando visivo', min:4, max:20, desc:'Reazione a colori/zone chiamate dal mister.', mats:{palloni:'per_giocatore', cinesini:20}},
                {id:'tec6', name:'Rondo 4 vs 1', min:5, max:20, desc:'Possesso rapido con 1 difendente in mezzo.', mats:{palloni:1, cinesini:8}},
                {id:'tec7', name:'Passaggi di prima con movimento continuo', min:6, max:20, desc:'Timing e orientamento del corpo con movimento.', mats:{palloni:2, cinesini:12}},
                {id:'tec8', name:'Ricezione e passaggio su porte colorate', min:6, max:20, desc:'Scelta rapida sul colore chiamato, decidere in fretta.', mats:{palloni:2, porticine:4, cinesini:12}},
                {id:'tec9', name:'Slalom + scarico palla + tiro', min:5, max:20, desc:'Progressione tecnica con finalizzazione.', mats:{palloni:3, conetti:12, porticine:1}},
                {id:'tec10', name:'2 vs 1 in spazi ridotti', min:5, max:20, desc:'Superiorità numerica e tempi di passaggio.', mats:{palloni:2, cinesini:8, porticine:2}}
            ],
            situazionale: [
                {id:'sit1', name:'3 vs 2 a salire', min:5, max:20, desc:'Attacco in superiorità numerica; chi recupera riparte.', mats:{palloni:2, porticine:2, cinesini:8}},
                {id:'sit2', name:'4 vs 3 con transizione', min:7, max:20, desc:'Cambio fase immediato al recupero palla.', mats:{palloni:2, porticine:2, cinesini:10, pettorine:7}},
                {id:'sit3', name:'Attacco veloce 2 vs 1 con conclusione', min:5, max:20, desc:'Scelta tra portare palla o passare, conclusione obbligatoria.', mats:{palloni:2, porticine:1, cinesini:6}},
                {id:'sit4', name:'3 vs 3 + 2 jolly esterni', min:8, max:20, desc:'Sfrutta ampiezza con jolly laterali fissi.', mats:{palloni:2, porticine:2, cinesini:12, pettorine:8}},
                {id:'sit5', name:'5 vs 4 partendo da metà campo', min:9, max:20, desc:'Sviluppo in zona offensiva, coperture e scalate.', mats:{palloni:2, porte:2, cinesini:12, pettorine:9}},
                {id:'sit6', name:'2 vs 2 + portieri', min:6, max:20, desc:'Rifinitura e conclusioni rapide con portieri.', mats:{palloni:2, porticine:2, pettorine:4}},
                {id:'sit7', name:'Sovrapposizioni obbligatorie', min:8, max:20, desc:'Tempismo, ampiezza e cross con sovrapposizione.', mats:{palloni:2, cinesini:12, porticine:2}},
                {id:'sit8', name:'Cross e finalizzazione (3 vs 2 in area)', min:7, max:20, desc:'Traversoni e attacco della palla in area.', mats:{palloni:3, porte:1, cinesini:12, paletti:6}},
                {id:'sit9', name:'Attacco da rimessa laterale (3 vs 2)', min:5, max:20, desc:'Schemi rapidi da rimessa laterale.', mats:{palloni:2, porticine:1, cinesini:6}},
                {id:'sit10', name:'Uscita palla da dietro (3 vs 2 pressing alto)', min:7, max:20, desc:'Costruzione pulita sotto pressione e linee di passaggio.', mats:{palloni:3, cinesini:16, porticine:2, pettorine:5}}
            ],
            gioco: [
                {id:'gio1', name:'4 vs 4 (gol valido dopo 3 passaggi)', min:8, max:20, desc:'Gol valido solo dopo 3 passaggi consecutivi.', mats:{palloni:1, porticine:2, pettorine:8}},
                {id:'gio2', name:'3 vs 3 con jolly neutrale', min:7, max:20, desc:'Il jolly gioca con chi ha possesso palla.', mats:{palloni:1, porticine:2, pettorine:7}},
                {id:'gio3', name:'Campo in 3 zone (passare in tutte)', min:8, max:20, desc:'Costruzione paziente, obbligo passaggio in tutte le zone.', mats:{palloni:1, porticine:2, cinesini:12, pettorine:8}},
                {id:'gio4', name:'Gol valido solo con esterno piede', min:8, max:20, desc:'Stimola controllo e coordinazione con esterno.', mats:{palloni:1, porticine:2, pettorine:8}},
                {id:'gio5', name:'Punti doppi se gol nasce da cross', min:10, max:20, desc:'Valorizza gioco sulle fasce e traversoni.', mats:{palloni:2, porte:2, cinesini:12, paletti:4, pettorine:10}},
                {id:'gio6', name:'Gol lampo entro 6 secondi', min:8, max:20, desc:'Transizioni e velocità decisionale, vale solo entro 6 secondi.', mats:{palloni:1, porticine:2, cronometro:1, pettorine:8}},
                {id:'gio7', name:'Gol valido solo se segnano tutti', min:8, max:20, desc:'Obiettivo: segnare almeno una volta a testa.', mats:{palloni:1, porticine:2, pettorine:8}},
                {id:'gio8', name:'Partita a 2 porte piccole per squadra', min:8, max:20, desc:'Ricerca di spazi e angoli di tiro diversi.', mats:{palloni:1, porticine:4, pettorine:8}},
                {id:'gio9', name:'Partita con portiere volante', min:10, max:20, desc:'Portiere partecipa al possesso e può segnare.', mats:{palloni:1, porte:2, pettorine:10}},
                {id:'gio10', name:'Re del campo', min:9, max:20, desc:'Chi segna resta in campo, chi subisce esce.', mats:{palloni:2, porticine:2, pettorine:9}}
            ],
            partita: [
                {id:'par1', name:'Partita 5 vs 5 (campo ridotto)', min:10, max:20, desc:'Applicazione su campo corto, intensità alta con regole ufficiali.', mats:{palloni:1, porticine:4, pettorine:10}},
                {id:'par2', name:'Partita 6 vs 6', min:12, max:20, desc:'Più linee di passaggio e coperture su campo medio.', mats:{palloni:1, porte:2, pettorine:12}},
                {id:'par3', name:'Partita 7 vs 7', min:14, max:20, desc:'Allarga spazi e tempi di gioco, più possesso.', mats:{palloni:1, porte:2, pettorine:14}},
                {id:'par4', name:'Partita 8 vs 8', min:16, max:20, desc:'Quasi formato 9v9, preparazione al gioco ufficiale.', mats:{palloni:1, porte:2, pettorine:16}},
                {id:'par5', name:'Partita 9 vs 9 (regole ufficiali)', min:18, max:20, desc:'Applicazione completa con fuorigioco ultimo terzo.', mats:{palloni:1, porte:2, pettorine:18}},
                {id:'par6', name:'Ruoli a rotazione ogni 5 minuti', min:12, max:20, desc:'Sperimentazione ruoli e responsabilità diverse.', mats:{palloni:1, porte:2, cronometro:1, pettorine:12}},
                {id:'par7', name:'Gol doppio dopo 5 passaggi', min:12, max:20, desc:'Premia il possesso paziente e la costruzione.', mats:{palloni:1, porte:2, pettorine:12}},
                {id:'par8', name:'Limite 3 tocchi', min:12, max:20, desc:'Velocità di esecuzione e smarcamenti continui.', mats:{palloni:1, porte:2, pettorine:12}},
                {id:'par9', name:'Campo diviso (no palla lunga)', min:12, max:20, desc:'Costruzione dal basso obbligata, no lanci lunghi.', mats:{palloni:1, porte:2, cinesini:12, pettorine:12}},
                {id:'par10', name:'Zona jolly: concludi entro 3 secondi', min:12, max:20, desc:'Finalizzazione rapida in zona designata.', mats:{palloni:1, porte:2, cinesini:8, cronometro:1, pettorine:12}}
            ],
            defaticamento: [
                {id:'def1', name:'Corsa lenta + stretching gambe', min:4, max:20, desc:'Rientro alla calma con corsa leggera e allungamento.', mats:{}},
                {id:'def2', name:'Camminata a coppie (feedback)', min:4, max:20, desc:'Condivisione di ciò che è piaciuto e imparato.', mats:{}},
                {id:'def3', name:'Stretching a stazioni (player leader)', min:4, max:20, desc:'Un giocatore guida ogni stazione di stretching.', mats:{cinesini:8}},
                {id:'def4', name:'Esercizi di respirazione + rilassamento', min:4, max:20, desc:'In piedi o seduti, focus sul respiro profondo.', mats:{}},
                {id:'def5', name:'Gioco leggero: palla in aria', min:4, max:20, desc:'Cooperazione, la palla non deve cadere a terra.', mats:{palloni:1}},
                {id:'def6', name:'Corsa lenta in cerchio + battimani ritmici', min:4, max:20, desc:'Battimani e respirazione coordinata in gruppo.', mats:{}},
                {id:'def7', name:'Stretching dinamico con musica', min:4, max:20, desc:'Movimenti lenti e controllati a ritmo di musica.', mats:{}},
                {id:'def8', name:'Gamba contro gamba (a coppie)', min:4, max:20, desc:'Allungamenti assistiti in coppia.', mats:{}},
                {id:'def9', name:'Mini-discussione: cosa ho imparato oggi?', min:4, max:20, desc:'Ogni giocatore condivide 1 idea appresa.', mats:{}},
                {id:'def10', name:'Saluto di squadra', min:4, max:20, desc:'Rituale finale positivo con grido di squadra.', mats:{}}
            ]
        };

        const PHASES = [
            {key: 'attivazione', name: 'Attivazione & Riscaldamento (0–10\')'},
            {key: 'tecnica', name: 'Tecnica di Base (10–25\')'},
            {key: 'situazionale', name: 'Esercizi Situazionali (25–45\')'},
            {key: 'gioco', name: 'Giochi a Tema (45–65\')'},
            {key: 'partita', name: 'Partita/Applicazione (65–85\')'},
            {key: 'defaticamento', name: 'Defaticamento & Feedback (85–90\')'}
        ];

        const MATERIAL_KEYS = ['palloni','cinesini','conetti','paletti','aste','porticine','porte','ostacoli','scale','pettorine','fischietto','cronometro','lavagnetta','nastro'];

        // Storage per esercizi personalizzati
        let customExercises = {};
        let lastPdfBlob = null;
        let tempState = null;

        function getPlayers() {
            const el = document.getElementById('presenti');
            let v = parseInt(el.value, 10);
            if (isNaN(v)) v = 12;
            v = Math.max(4, Math.min(20, v));
            el.value = v;
            return v;
        }

        function renderPhases() {
            const container = document.getElementById('phases-container');
            if (!container) {
                console.error('Container phases-container non trovato!');
                return;
            }
            
            const presenti = getPlayers();
            container.innerHTML = '';
            
            PHASES.forEach(phase => {
                // Trova esercizi compatibili dal database
                const availableExercises = DB[phase.key].filter(ex => presenti >= ex.min && presenti <= ex.max);
                
                const phaseDiv = document.createElement('div');
                phaseDiv.className = 'phase';
                
                let optionsHtml = '<option value="">-- Seleziona esercizio --</option>';
                availableExercises.forEach(ex => {
                    optionsHtml += `<option value="${ex.id}">${ex.name}</option>`;
                });
                
                // Aggiungi opzione per esercizio personalizzato
                optionsHtml += `<option value="custom-${phase.key}">+ Esercizio personalizzato</option>`;
                
                // Aggiungi esercizio personalizzato esistente se presente
                if (customExercises[phase.key]) {
                    const custom = customExercises[phase.key];
                    optionsHtml += `<option value="custom-${phase.key}-saved">${custom.name} <span class="custom-exercise-badge">CUSTOM</span></option>`;
                }
                
                phaseDiv.innerHTML = `
                    <div class="phase-header">${phase.name}</div>
                    <div style="font-size: 0.9rem; color: #666; margin-bottom: 10px;">
                        ${availableExercises.length} esercizi disponibili per ${presenti} giocatori
                    </div>
                    <select id="select-${phase.key}" data-phase="${phase.key}">
                        ${optionsHtml}
                    </select>
                    <div id="details-${phase.key}"></div>
                    <div id="custom-form-${phase.key}" class="custom-form">
                        <h4>Crea Esercizio Personalizzato</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Nome esercizio</label>
                                <input type="text" id="custom-name-${phase.key}" placeholder="es. Passaggi con ostacoli">
                            </div>
                            <div class="form-group">
                                <label>Descrizione</label>
                                <textarea id="custom-desc-${phase.key}" rows="3" placeholder="Descrivi l'esercizio nel dettaglio..."></textarea>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Materiale necessario</label>
                            <div class="materials-selector" id="materials-${phase.key}">
                                ${MATERIAL_KEYS.map(key => `
                                    <div class="material-item">
                                        <label>${labelFor(key)}</label>
                                        <input type="number" id="mat-${key}-${phase.key}" min="0" max="99" value="0">
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div class="custom-form-buttons">
                            <button class="btn-small primary" onclick="saveCustomExercise('${phase.key}')">Salva</button>
                            <button class="btn-small secondary" onclick="cancelCustomExercise('${phase.key}')">Annulla</button>
                        </div>
                    </div>
                `;
                
                container.appendChild(phaseDiv);
            });
            
            // Aggiungi event listener ai select
            const selects = container.querySelectorAll('select');
            selects.forEach(select => {
                select.addEventListener('change', function() {
                    const phaseKey = this.dataset.phase;
                    const value = this.value;
                    
                    if (value === `custom-${phaseKey}`) {
                        showCustomForm(phaseKey);
                        updateExerciseDetails(phaseKey, '');
                    } else if (value === `custom-${phaseKey}-saved`) {
                        hideCustomForm(phaseKey);
                        updateExerciseDetails(phaseKey, value);
                    } else {
                        hideCustomForm(phaseKey);
                        updateExerciseDetails(phaseKey, value);
                    }
                    
                    updateTotalMaterials();
                    updateValidityStatus();
                });
            });
        }

        function showCustomForm(phaseKey) {
            const form = document.getElementById(`custom-form-${phaseKey}`);
            if (form) {
                form.classList.add('active');
            }
        }

        function hideCustomForm(phaseKey) {
            const form = document.getElementById(`custom-form-${phaseKey}`);
            if (form) {
                form.classList.remove('active');
            }
        }

        function saveCustomExercise(phaseKey) {
            const name = document.getElementById(`custom-name-${phaseKey}`).value.trim();
            const desc = document.getElementById(`custom-desc-${phaseKey}`).value.trim();
            
            if (!name || !desc) {
                alert('Inserire nome e descrizione dell\'esercizio');
                return;
            }
            
            // Raccogli materiali
            const mats = {};
            MATERIAL_KEYS.forEach(key => {
                const qty = parseInt(document.getElementById(`mat-${key}-${phaseKey}`).value) || 0;
                if (qty > 0) {
                    mats[key] = qty;
                }
            });
            
            // Salva esercizio personalizzato
            customExercises[phaseKey] = {
                id: `custom-${phaseKey}-saved`,
                name: name,
                desc: desc,
                mats: mats,
                custom: true
            };
            
            // Aggiorna la UI
            renderPhases();
            
            // Seleziona automaticamente l'esercizio appena creato
            const select = document.getElementById(`select-${phaseKey}`);
            if (select) {
                select.value = `custom-${phaseKey}-saved`;
                updateExerciseDetails(phaseKey, `custom-${phaseKey}-saved`);
                updateTotalMaterials();
                updateValidityStatus();
            }
        }

        function cancelCustomExercise(phaseKey) {
            const select = document.getElementById(`select-${phaseKey}`);
            if (select) {
                select.value = '';
            }
            
            hideCustomForm(phaseKey);
            updateExerciseDetails(phaseKey, '');
            updateTotalMaterials();
            updateValidityStatus();
        }

        function getExerciseById(id) {
            // Prima controlla negli esercizi personalizzati
            for (const phaseKey in customExercises) {
                if (customExercises[phaseKey].id === id) {
                    return customExercises[phaseKey];
                }
            }
            
            // Poi nel database normale
            for (const phaseKey in DB) {
                const found = DB[phaseKey].find(ex => ex.id === id);
                if (found) return found;
            }
            return null;
        }

        function resolveMaterials(mats, presenti) {
            const resolved = {};
            for (const [key, value] of Object.entries(mats)) {
                if (typeof value === 'string') {
                    switch (value) {
                        case 'per_giocatore':
                            resolved[key] = presenti;
                            break;
                        case 'per_coppia':
                            resolved[key] = Math.ceil(presenti / 2);
                            break;
                        case 'giocatori_meno_1':
                            resolved[key] = Math.max(presenti - 1, 1);
                            break;
                        default:
                            resolved[key] = 0;
                    }
                } else {
                    resolved[key] = value;
                }
            }
            return resolved;
        }

        function labelFor(key) {
            const labels = {
                palloni: 'Palloni',
                cinesini: 'Cinesini',
                conetti: 'Conetti',
                paletti: 'Paletti',
                aste: 'Aste',
                porticine: 'Porticine',
                porte: 'Porte',
                ostacoli: 'Ostacoli',
                scale: 'Scale di velocità',
                pettorine: 'Pettorine',
                fischietto: 'Fischietto',
                cronometro: 'Cronometro',
                lavagnetta: 'Lavagnetta',
                nastro: 'Nastro segnaletico'
            };
            return labels[key] || key;
        }

        function updateExerciseDetails(phaseKey, exerciseId) {
            const detailsDiv = document.getElementById(`details-${phaseKey}`);
            
            if (!exerciseId) {
                detailsDiv.innerHTML = '';
                return;
            }
            
            const exercise = getExerciseById(exerciseId);
            if (!exercise) {
                detailsDiv.innerHTML = '';
                return;
            }
            
            const presenti = getPlayers();
            const resolvedMats = resolveMaterials(exercise.mats, presenti);
            
            let matChips = '';
            for (const [key, qty] of Object.entries(resolvedMats)) {
                if (qty > 0) {
                    matChips += `<span class="mat-chip">${labelFor(key)}: ${qty}</span> `;
                }
            }
            
            const customBadge = exercise.custom ? '<span class="custom-exercise-badge">PERSONALIZZATO</span>' : '';
            
            detailsDiv.innerHTML = `
                <div class="exercise-details">
                    <div class="exercise-desc">${exercise.desc} ${customBadge}</div>
                    <div class="exercise-mats">${matChips}</div>
                </div>
            `;
        }

        function updateTotalMaterials() {
            const presenti = getPlayers();
            const totals = {};
            let maxPalloni = 0;
            
            // Inizializza tutte le chiavi a 0
            MATERIAL_KEYS.forEach(k => totals[k] = 0);
            
            PHASES.forEach(phase => {
                const select = document.getElementById(`select-${phase.key}`);
                if (!select || !select.value) return;
                
                const exercise = getExerciseById(select.value);
                if (exercise) {
                    const resolved = resolveMaterials(exercise.mats, presenti);
                    
                    for (const [key, qty] of Object.entries(resolved)) {
                        if (key === 'palloni') {
                            maxPalloni = Math.max(maxPalloni, qty);
                        } else {
                            totals[key] = (totals[key] || 0) + qty;
                        }
                    }
                }
            });
            
            // Imposta palloni come massimo, non somma
            if (maxPalloni > 0) {
                totals.palloni = maxPalloni;
            }
            
            // Assicura minimi per allenamento base
            if (totals.palloni < presenti) {
                totals.palloni = presenti;
            }
            if (totals.pettorine < presenti) {
                totals.pettorine = presenti;
            }
            
            const container = document.getElementById('total-materials');
            const nonZeroTotals = Object.entries(totals).filter(([key, qty]) => qty > 0);
            
            if (nonZeroTotals.length === 0) {
                container.innerHTML = '<div class="guide-text">Seleziona gli esercizi per vedere il materiale necessario</div>';
                return;
            }
            
            let chips = '';
            nonZeroTotals.forEach(([key, qty]) => {
                chips += `<span class="total-chip">${labelFor(key)}: ${qty}</span> `;
            });
            
            container.innerHTML = chips;
        }

        function updateValidityStatus() {
            const validityElement = document.getElementById('validity-status');
            const selectedCount = PHASES.filter(phase => {
                const select = document.getElementById(`select-${phase.key}`);
                return select && select.value && !select.value.endsWith(`custom-${phase.key}`);
            }).length;
            
            validityElement.textContent = `${selectedCount}/6 esercizi selezionati`;
            
            if (selectedCount === 6) {
                validityElement.className = 'validity-status validity-complete';
                validityElement.textContent += ' · pronto per PDF';
            } else {
                validityElement.className = 'validity-status validity-incomplete';
            }
        }

        function autofillExercises() {
            const presenti = getPlayers();
            
            PHASES.forEach(phase => {
                const select = document.getElementById(`select-${phase.key}`);
                const availableExercises = DB[phase.key].filter(ex => presenti >= ex.min && presenti <= ex.max);
                
                if (availableExercises.length > 0) {
                    select.value = availableExercises[0].id;
                    hideCustomForm(phase.key);
                    updateExerciseDetails(phase.key, availableExercises[0].id);
                }
            });
            
            updateTotalMaterials();
            updateValidityStatus();
        }

        function clearSelections() {
            PHASES.forEach(phase => {
                const select = document.getElementById(`select-${phase.key}`);
                if (select) {
                    select.value = '';
                    hideCustomForm(phase.key);
                    updateExerciseDetails(phase.key, '');
                }
            });
            updateTotalMaterials();
            updateValidityStatus();
        }

        function saveToMemory() {
            const state = {
                meta: {
                    presenti: getPlayers(),
                    data: document.getElementById('data').value,
                    ora: document.getElementById('ora').value,
                    campo: document.getElementById('campo').value,
                    mister: document.getElementById('mister').value,
                    categoria: document.getElementById('categoria').value,
                    note: document.getElementById('note').value
                },
                selections: {},
                customExercises: JSON.parse(JSON.stringify(customExercises))
            };
            
            PHASES.forEach(phase => {
                const select = document.getElementById(`select-${phase.key}`);
                state.selections[phase.key] = select ? select.value : '';
            });
            
            tempState = state;
            alert('Stato salvato temporaneamente (inclusi esercizi personalizzati)!');
        }

        function loadFromMemory() {
            if (!tempState) {
                alert('Nessun stato temporaneo salvato.');
                return;
            }
            
            // Ripristina esercizi personalizzati
            if (tempState.customExercises) {
                customExercises = JSON.parse(JSON.stringify(tempState.customExercises));
            }
            
            // Ripristina metadati
            if (tempState.meta) {
                document.getElementById('presenti').value = tempState.meta.presenti || 12;
                document.getElementById('data').value = tempState.meta.data || '';
                document.getElementById('ora').value = tempState.meta.ora || '17:00';
                document.getElementById('campo').value = tempState.meta.campo || '';
                document.getElementById('mister').value = tempState.meta.mister || '';
                document.getElementById('categoria').value = tempState.meta.categoria || 'Esordienti';
                document.getElementById('note').value = tempState.meta.note || '';
            }
            
            // Aggiorna fasi
            renderPhases();
            
            // Ripristina selezioni
            if (tempState.selections) {
                PHASES.forEach(phase => {
                    const select = document.getElementById(`select-${phase.key}`);
                    const savedValue = tempState.selections[phase.key];
                    if (select && savedValue) {
                        select.value = savedValue;
                        updateExerciseDetails(phase.key, savedValue);
                    }
                });
            }
            
            updateTotalMaterials();
            updateValidityStatus();
            alert('Stato temporaneo caricato (inclusi esercizi personalizzati)!');
        }

        function exportPDF() {
            const meta = {
                presenti: getPlayers(),
                data: document.getElementById('data').value,
                ora: document.getElementById('ora').value,
                campo: document.getElementById('campo').value,
                mister: document.getElementById('mister').value,
                categoria: document.getElementById('categoria').value,
                note: document.getElementById('note').value
            };
            
            if (!meta.presenti || meta.presenti < 4 || meta.presenti > 20) {
                alert('Inserire un numero di presenti valido (4-20).');
                return;
            }
            
            const lines = [];
            
            // Titolo
            lines.push('Mister 2.0 — Scheda Allenamento');
            lines.push('');
            
            // Dati allenamento
            const dataStr = meta.data ? new Date(meta.data + 'T00:00:00').toLocaleDateString('it-IT') : '___';
            const oraStr = meta.ora || '___';
            const campoStr = meta.campo || '___';
            lines.push(`Data: ${dataStr}   Ora: ${oraStr}   Campo: ${campoStr}`);
            
            const categoriaStr = meta.categoria || '___';
            const misterStr = meta.mister || '___';
            lines.push(`Categoria: ${categoriaStr}   Mister: ${misterStr}   Presenti: ${meta.presenti}`);
            
            if (meta.note && meta.note.trim()) {
                const noteLines = wrapText(`Note: ${meta.note.trim()}`);
                lines.push(...noteLines);
            }
            
            lines.push('');
            lines.push('FASI & ESERCIZI:');
            lines.push('');
            
            // Fasi ed esercizi
            PHASES.forEach((phase, index) => {
                const select = document.getElementById(`select-${phase.key}`);
                const exerciseId = select ? select.value : '';
                
                lines.push(`${index + 1}. ${phase.name}:`);
                
                if (exerciseId && !exerciseId.endsWith(`custom-${phase.key}`)) {
                    const exercise = getExerciseById(exerciseId);
                    if (exercise) {
                        const customLabel = exercise.custom ? ' [PERSONALIZZATO]' : '';
                        lines.push(`   Esercizio: ${exercise.name}${customLabel}`);
                        const descLines = wrapText(`   Descrizione: ${exercise.desc}`, 85);
                        lines.push(...descLines);
                        
                        const resolved = resolveMaterials(exercise.mats, meta.presenti);
                        const matList = [];
                        for (const [key, qty] of Object.entries(resolved)) {
                            if (qty > 0) {
                                matList.push(`${labelFor(key)} ${qty}`);
                            }
                        }
                        
                        if (matList.length > 0) {
                            const matLines = wrapText(`   Materiale: ${matList.join(', ')}`, 85);
                            lines.push(...matLines);
                        }
                    }
                } else {
                    lines.push('   — (non selezionato) —');
                }
                
                lines.push('');
            });
            
            // Materiale totale
            const totals = aggregateTotalsForPrint(meta.presenti);
            if (Object.keys(totals).length > 0) {
                lines.push('MATERIALE TOTALE:');
                const totalList = [];
                for (const [key, qty] of Object.entries(totals)) {
                    if (qty > 0) {
                        totalList.push(`${labelFor(key)} ${qty}`);
                    }
                }
                
                if (totalList.length > 0) {
                    const totalLines = wrapText(totalList.join(', '), 85);
                    lines.push(...totalLines);
                }
            }
            
            // Aggiungi crediti
            lines.push('');
            lines.push('Generato con Mister 2.0 by 2M Digital Consulting srls');
            
            // Genera PDF
            const pdfString = buildSimplePDF(lines);
            const blob = new Blob([pdfString], {type: 'application/pdf'});
            lastPdfBlob = blob;
            
            // Download
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            
            const dateStr = meta.data || new Date().toISOString().split('T')[0];
            const filename = `Mister20_${dateStr}_${meta.categoria}_${meta.presenti}p.pdf`;
            a.download = filename;
            
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function aggregateTotalsForPrint(presenti) {
            const totals = {};
            let maxPalloni = 0;
            
            // Inizializza tutte le chiavi
            MATERIAL_KEYS.forEach(k => totals[k] = 0);
            
            PHASES.forEach(phase => {
                const select = document.getElementById(`select-${phase.key}`);
                if (!select || !select.value || select.value.endsWith(`custom-${phase.key}`)) return;
                
                const exercise = getExerciseById(select.value);
                if (exercise) {
                    const resolved = resolveMaterials(exercise.mats, presenti);
                    
                    for (const [key, qty] of Object.entries(resolved)) {
                        if (key === 'palloni') {
                            maxPalloni = Math.max(maxPalloni, qty);
                        } else {
                            totals[key] = (totals[key] || 0) + qty;
                        }
                    }
                }
            });
            
            // Imposta palloni come massimo
            if (maxPalloni > 0) {
                totals.palloni = maxPalloni;
            }
            
            // Assicura minimi
            if (totals.palloni < presenti) {
                totals.palloni = presenti;
            }
            if (totals.pettorine < presenti) {
                totals.pettorine = presenti;
            }
            
            // Rimuovi zeri
            Object.keys(totals).forEach(k => {
                if (totals[k] === 0) delete totals[k];
            });
            
            return totals;
        }

        function wrapText(text, maxChars = 95) {
            if (text.length <= maxChars) return [text];
            
            const words = text.split(' ');
            const lines = [];
            let currentLine = '';
            
            words.forEach(word => {
                if ((currentLine + ' ' + word).length <= maxChars) {
                    currentLine += (currentLine ? ' ' : '') + word;
                } else {
                    if (currentLine) lines.push(currentLine);
                    currentLine = word;
                }
            });
            
            if (currentLine) lines.push(currentLine);
            return lines;
        }

        function escapeString(str) {
            return str.replace(/\\/g, '\\\\')
                     .replace(/\(/g, '\\(')
                     .replace(/\)/g, '\\)')
                     .replace(/\r/g, '\\r')
                     .replace(/\n/g, '\\n');
        }

        function calculateStreamLength(lines) {
            let length = 0;
            length += 'BT\n'.length;
            length += '/F1 16 Tf\n'.length;
            length += '50 800 Td\n'.length;
            
            lines.forEach((line, i) => {
                length += `(${escapeString(line)}) Tj\n`.length;
                if (i === 0) {
                    length += '0 -20 Td\n'.length;
                    length += '/F1 12 Tf\n'.length;
                } else {
                    length += '0 -14 Td\n'.length;
                }
            });
            
            length += 'ET\n'.length;
            return length;
        }

        function buildSimplePDF(lines) {
            const streamLength = calculateStreamLength(lines);
            
            const pdfContent = [
                '%PDF-1.4',
                '1 0 obj',
                '<<',
                '/Type /Catalog',
                '/Pages 2 0 R',
                '>>',
                'endobj',
                '',
                '2 0 obj',
                '<<',
                '/Type /Pages',
                '/Kids [3 0 R]',
                '/Count 1',
                '>>',
                'endobj',
                '',
                '3 0 obj',
                '<<',
                '/Type /Page',
                '/Parent 2 0 R',
                '/MediaBox [0 0 595.28 841.89]',
                '/Resources <<',
                '  /Font <<',
                '    /F1 4 0 R',
                '  >>',
                '>>',
                '/Contents 5 0 R',
                '>>',
                'endobj',
                '',
                '4 0 obj',
                '<<',
                '/Type /Font',
                '/Subtype /Type1',
                '/BaseFont /Helvetica',
                '>>',
                'endobj',
                '',
                '5 0 obj',
                '<<',
                '/Length ' + streamLength.toString(),
                '>>',
                'stream'
            ];
            
            // Content stream
            pdfContent.push('BT');
            pdfContent.push('/F1 16 Tf');
            pdfContent.push('50 800 Td');
            
            lines.forEach((line, i) => {
                if (i === 0) {
                    pdfContent.push(`(${escapeString(line)}) Tj`);
                    pdfContent.push('0 -20 Td');
                    pdfContent.push('/F1 12 Tf');
                } else {
                    pdfContent.push(`(${escapeString(line)}) Tj`);
                    pdfContent.push('0 -14 Td');
                }
            });
            
            pdfContent.push('ET');
            pdfContent.push('endstream');
            pdfContent.push('endobj');
            
            // Xref table
            const xrefPos = pdfContent.join('\n').length + 1;
            pdfContent.push('');
            pdfContent.push('xref');
            pdfContent.push('0 6');
            pdfContent.push('0000000000 65535 f ');
            pdfContent.push('0000000009 00000 n ');
            pdfContent.push('0000000074 00000 n ');
            pdfContent.push('0000000120 00000 n ');
            pdfContent.push('0000000274 00000 n ');
            pdfContent.push('0000000354 00000 n ');
            
            // Trailer
            pdfContent.push('trailer');
            pdfContent.push('<<');
            pdfContent.push('/Size 6');
            pdfContent.push('/Root 1 0 R');
            pdfContent.push('>>');
            pdfContent.push('startxref');
            pdfContent.push(xrefPos.toString());
            pdfContent.push('%%EOF');
            
            return pdfContent.join('\n');
        }

        function shareWhatsApp() {
            if (!lastPdfBlob) {
                alert('Genera prima un PDF per condividerlo su WhatsApp.');
                return;
            }
            
            const meta = {
                presenti: getPlayers(),
                data: document.getElementById('data').value,
                categoria: document.getElementById('categoria').value
            };
            
            const message = `🏃‍♂️ Scheda allenamento ${meta.categoria} - ${meta.presenti} presenti\n📅 Data: ${meta.data || 'da definire'}\n⚽ Creato con Mister 2.0 by 2M Digital Consulting\n\nVedi allegato PDF per i dettagli completi dell'allenamento.`;
            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/?text=${encodedMessage}`;
            
            window.open(whatsappUrl, '_blank');
        }

        function init() {
            // Set today's date and year
            const today = new Date();
            document.getElementById('data').value = today.toISOString().split('T')[0];
            document.getElementById('year').textContent = today.getFullYear();
            
            // Aggiungi event listener per cambio numero presenti
            document.getElementById('presenti').addEventListener('input', function() {
                renderPhases();
                updateTotalMaterials();
                updateValidityStatus();
            });
            
            // Renderizza le fasi iniziali
            renderPhases();
            updateTotalMaterials();
            updateValidityStatus();
        }

        // Inizializzazione quando il DOM è pronto
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
