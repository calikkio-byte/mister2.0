<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mister 2.0 ‚Äì Planner Allenamenti</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #4CAF50 100%);
            color: #333;
            line-height: 1.6;
            position: relative;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(76, 175, 80, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            width: 100%;
            box-sizing: border-box;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px;
            background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.9) 100%);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(from 0deg, transparent, rgba(76, 175, 80, 0.1), transparent, rgba(30, 60, 114, 0.1), transparent);
            animation: rotate 20s linear infinite;
            z-index: -1;
        }
        
        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .header h1 {
            background: linear-gradient(135deg, #1e3c72 0%, #4CAF50 50%, #FFD700 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 3rem;
            font-weight: 800;
            margin-bottom: 10px;
            text-shadow: 0 4px 8px rgba(0,0,0,0.1);
            position: relative;
            z-index: 1;
        }
        
        .header .subtitle {
            color: #555;
            font-size: 1.1rem;
            font-style: italic;
            font-weight: 500;
            position: relative;
            z-index: 1;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        .form-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .form-section h2 {
            color: #0aa85e;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #0aa85e;
            box-shadow: 0 0 0 3px rgba(10, 168, 94, 0.1);
        }
        
        .phases-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .phase {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #fafafa;
        }
        
        .phase-header {
            font-weight: 600;
            color: #0aa85e;
            margin-bottom: 10px;
        }
        
        .phase select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .phase select:focus {
            outline: none;
            border-color: #0aa85e;
            box-shadow: 0 0 0 3px rgba(10, 168, 94, 0.1);
        }
        
        .exercise-details {
            background: white;
            padding: 12px;
            border-radius: 6px;
            margin-top: 10px;
            border-left: 4px solid #0aa85e;
        }
        
        .exercise-desc {
            margin-bottom: 8px;
            color: #555;
        }
        
        .exercise-mats {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        
        .mat-chip {
            background: #0aa85e;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .custom-form {
            background: #fff;
            border: 2px solid #0aa85e;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            display: none;
        }
        
        .custom-form.active {
            display: block;
        }
        
        .custom-form h4 {
            color: #0aa85e;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }
        
        .custom-form .form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }
        
        .custom-form .form-group input,
        .custom-form .form-group textarea {
            font-size: 13px;
        }
        
        .materials-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .material-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f9f9f9;
            padding: 8px;
            border-radius: 6px;
        }
        
        .material-item label {
            font-size: 12px;
            font-weight: 500;
            min-width: 80px;
        }
        
        .material-item input {
            width: 50px;
            padding: 4px;
            font-size: 12px;
            text-align: center;
        }
        
        .custom-form-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .btn-small.primary {
            background: #0aa85e;
            color: white;
        }
        
        .btn-small.secondary {
            background: #f0f0f0;
            color: #333;
            border: 1px solid #ddd;
        }
        
        .sidebar {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            height: fit-content;
            position: sticky;
            top: 20px;
        }
        
        .sidebar h3 {
            color: #0aa85e;
            margin-bottom: 15px;
        }
        
        .total-materials {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .total-chip {
            background: #f0f0f0;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 13px;
            border: 1px solid #ddd;
        }
        
        .button-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .btn {
            padding: 12px 16px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-align: center;
            text-decoration: none;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn:hover::before {
            left: 100%;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #45a049 0%, #4CAF50 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            color: #495057;
            border: 1px solid #dee2e6;
        }
        
        .btn-secondary:hover {
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
        }
        
        .btn-danger:hover {
            background: linear-gradient(135deg, #c82333 0%, #dc3545 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(220, 53, 69, 0.4);
        }
        
        .btn-whatsapp {
            background: linear-gradient(135deg, #25d366 0%, #20ba5a 100%);
            color: white;
        }
        
        .btn-whatsapp:hover {
            background: linear-gradient(135deg, #20ba5a 0%, #25d366 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(37, 211, 102, 0.4);
        }
        
        .footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: #666;
            font-size: 0.9rem;
        }
        
        .guide-text {
            color: #999;
            font-style: italic;
            padding: 20px;
            text-align: center;
        }
        
        .required {
            color: #dc3545;
        }
        
        .validity-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .validity-incomplete {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .validity-complete {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .custom-exercise-badge {
            background: #ff6b6b;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 500;
            margin-left: 8px;
        }

        /* Tactical Editor Styles */
        .tactical-editor {
            background: white;
            border: 2px solid #0aa85e;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            display: none;
        }

        .tactical-editor.active {
            display: block;
        }

        .tactical-editor h4 {
            color: #0aa85e;
            margin-bottom: 15px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tactical-editor h4::before {
            content: "‚öΩ";
            font-size: 1.2rem;
        }

        .tactical-canvas-container {
            position: relative;
            background: #2d5a2d;
            border: 3px solid #000;
            border-radius: 8px;
            margin: 10px 0;
            overflow: hidden;
            width: 100%;
            max-width: 400px;
        }

        .tactical-canvas {
            display: block;
            cursor: crosshair;
            background: #2d5a2d;
            width: 100%;
            height: auto;
            max-width: 100%;
        }

        .tactical-tools {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .tool-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .tool-group label {
            font-size: 12px;
            font-weight: 600;
            color: #333;
        }

        .tool-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .tool-btn {
            padding: 6px 10px;
            border: 2px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            transition: all 0.2s;
            min-width: 40px;
            text-align: center;
        }

        .tool-btn.active {
            background: #0aa85e;
            color: white;
            border-color: #0aa85e;
        }

        .tool-btn:hover {
            border-color: #0aa85e;
        }

        .color-palette {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .color-btn {
            width: 24px;
            height: 24px;
            border: 2px solid #333;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
        }

        .color-btn.active {
            border-color: #fff;
            box-shadow: 0 0 0 2px #0aa85e;
        }

        .color-red { background: #ff0000; }
        .color-blue { background: #0000ff; }
        .color-yellow { background: #ffff00; }
        .color-white { background: #ffffff; }
        .color-black { background: #000000; }
        .color-orange { background: #ffa500; }

        .brush-size {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .brush-size input[type="range"] {
            flex: 1;
            min-width: 60px;
        }

        .brush-size span {
            font-size: 11px;
            font-weight: 600;
            min-width: 30px;
        }

        .tactical-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .tactical-actions .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .tactical-status {
            font-size: 11px;
            color: #666;
            margin-top: 8px;
            padding: 5px;
            background: #f0f0f0;
            border-radius: 4px;
        }

        @media (max-width: 768px) {
            .tactical-editor {
                margin: 5px 0;
                padding: 10px;
            }
            
            .tactical-tools {
                grid-template-columns: 1fr;
                gap: 8px;
                padding: 8px;
            }
            
            .tool-buttons {
                justify-content: center;
                flex-wrap: wrap;
            }
            
            .color-palette {
                justify-content: center;
            }
            
            .tactical-canvas-container {
                margin: 5px 0;
                border-width: 2px;
            }
            
            .tactical-actions {
                display: flex;
                flex-wrap: wrap;
                gap: 5px;
                justify-content: center;
            }
            
            .tactical-actions .btn-small {
                font-size: 12px;
                padding: 6px 8px;
            }
        }
        
        @media (max-width: 480px) {
            .tactical-editor {
                padding: 8px;
            }
            
            .tactical-canvas-container {
                max-width: 100%;
                margin: 5px -8px;
            }
            
            .tactical-tools {
                grid-template-columns: 1fr;
                padding: 5px;
            }
            
            .tool-buttons {
                gap: 3px;
            }
            
            .tool-btn {
                padding: 4px 6px;
                font-size: 11px;
            }
            
            .color-btn {
                width: 20px;
                height: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Mister 2.0 ‚Äì Planner Allenamenti</h1>
            <div class="subtitle">by 2M Digital Consulting srls</div>
        </div>
        
        <div class="main-content">
            <div class="left-column">
                <div class="form-section">
                    <h2>Dati Allenamento</h2>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="presenti">Numero presenti <span class="required">*</span></label>
                            <select id="presenti" required>
                                <option value="4">4 giocatori</option>
                                <option value="5">5 giocatori</option>
                                <option value="6">6 giocatori</option>
                                <option value="7">7 giocatori</option>
                                <option value="8">8 giocatori</option>
                                <option value="9">9 giocatori</option>
                                <option value="10">10 giocatori</option>
                                <option value="11">11 giocatori</option>
                                <option value="12" selected>12 giocatori</option>
                                <option value="13">13 giocatori</option>
                                <option value="14">14 giocatori</option>
                                <option value="15">15 giocatori</option>
                                <option value="16">16 giocatori</option>
                                <option value="17">17 giocatori</option>
                                <option value="18">18 giocatori</option>
                                <option value="19">19 giocatori</option>
                                <option value="20">20 giocatori</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="data">Data</label>
                            <input type="date" id="data">
                        </div>
                        <div class="form-group">
                            <label for="ora">Ora</label>
                            <input type="time" id="ora" value="17:00">
                        </div>
                        <div class="form-group">
                            <label for="campo">Campo</label>
                            <input type="text" id="campo" placeholder="es. Campo A">
                        </div>
                        <div class="form-group">
                            <label for="mister">Mister</label>
                            <input type="text" id="mister" placeholder="Nome allenatore">
                        </div>
                        <div class="form-group">
                            <label for="categoria">Categoria</label>
                            <select id="categoria">
                                <option value="Primi Calci">Primi Calci</option>
                                <option value="Pulcini">Pulcini</option>
                                <option value="Esordienti" selected>Esordienti</option>
                                <option value="Giovanissimi">Giovanissimi</option>
                                <option value="Allievi">Allievi</option>
                                <option value="Juniores">Juniores</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group" style="margin-top: 15px;">
                        <label for="note">Note</label>
                        <textarea id="note" rows="3" placeholder="Note aggiuntive per l'allenamento"></textarea>
                    </div>
                </div>
                
                <div class="phases-section">
                    <h2>Fasi Allenamento</h2>
                    <div style="margin-bottom: 15px;">
                        <span id="validity-status" class="validity-status validity-incomplete">0/6 esercizi selezionati</span>
                    </div>
                    <div id="phases-container"></div>
                </div>
            </div>
            
            <div class="sidebar">
                <h3>Materiale Totale</h3>
                <div id="total-materials" class="total-materials">
                    <div class="guide-text">Seleziona gli esercizi per vedere il materiale necessario</div>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-secondary" onclick="autofillExercises()">Suggerisci set completo</button>
                    <button class="btn btn-danger" onclick="clearSelections()">Svuota selezioni</button>
                    <button class="btn btn-primary" onclick="exportPDF()">Esporta PDF</button>
                    <button class="btn btn-whatsapp" onclick="shareWhatsApp()">Invia su WhatsApp</button>
                </div>
            </div>
        </div>
        
        <div class="footer">
            ¬© <span id="year"></span> Mister 2.0 ‚Äì Planner Allenamenti by 2M Digital Consulting srls
        </div>
    </div>

    <script>
        // Database esercizi
        const DB = {
            attivazione: [
                {id:'att1', name:'Corsa libera con cambi direzione al fischio', min:4, max:20, desc:'Corsa libera in spazio delimitato; al fischio cambio direzione o gesto tecnico.', mats:{fischietto:1, cinesini:8}},
                {id:'att2', name:'Staffetta a squadre con conduzione palla', min:6, max:20, desc:'Squadre in file: guida palla, gira il cono e rientra, tocca il compagno.', mats:{palloni:'per_giocatore', cinesini:12}},
                {id:'att3', name:'Gioco del "colpisci il cono"', min:4, max:20, desc:'Tiro di precisione su conetti a distanza crescente correndo.', mats:{palloni:3, conetti:12}},
                {id:'att4', name:'Quadrato coordinativo', min:4, max:20, desc:'Skip, balzi, scatti sui 4 lati del quadrato coordinativo.', mats:{cinesini:16}},
                {id:'att5', name:'Rubapalla (tutti con palla)', min:4, max:20, desc:'Ognuno guida la propria palla proteggendola, rubando quella degli altri.', mats:{palloni:'per_giocatore', cinesini:8}},
                {id:'att6', name:'Corsa a coppie legati per mano', min:4, max:20, desc:'A coppie, corsa sincronizzata con cambi ritmo/direzione.', mats:{cinesini:8}},
                {id:'att7', name:'Slalom tra conetti a tempo', min:4, max:20, desc:'Slalom tra conetti, sfida a tempo.', mats:{conetti:12, cronometro:1}},
                {id:'att8', name:'Chi ha la palla?', min:5, max:20, desc:'Un pallone in meno dei giocatori: chi resta senza corre a recuperarne uno.', mats:{palloni:'giocatori_meno_1', cinesini:6}},
                {id:'att9', name:'Circuito motorio', min:4, max:20, desc:'Stazioni: corsa, saltelli, scatti brevi.', mats:{cinesini:12}},
                {id:'att10', name:'Conduzione con cambio piede/direzione', min:4, max:20, desc:'Guida palla e cambia piede/direzione a comando del mister.', mats:{palloni:'per_giocatore', fischietto:1, cinesini:10}}
            ],
            tecnica: [
                {id:'tec1', name:'Passaggi a coppie con stop orientato', min:4, max:20, desc:'A coppie: controllo orientato e passaggio preciso.', mats:{palloni:'per_coppia', cinesini:8}},
                {id:'tec2', name:'Triangoli di passaggio con movimento', min:6, max:20, desc:'Sequenze a 3 con movimento continuo e rotazione.', mats:{palloni:2, cinesini:12}},
                {id:'tec3', name:'Guida palla tra ostacoli + tiro finale', min:4, max:20, desc:'Slalom e conclusione su porticine o porte.', mats:{palloni:'per_giocatore', conetti:12, porticine:2}},
                {id:'tec4', name:'1 vs 1 a porte piccole', min:4, max:20, desc:'Duelli rapidi con tante ripetizioni su porte ridotte.', mats:{palloni:2, porticine:2, cinesini:8}},
                {id:'tec5', name:'Conduzione su comando visivo', min:4, max:20, desc:'Reazione a colori/zone chiamate dal mister.', mats:{palloni:'per_giocatore', cinesini:20}},
                {id:'tec6', name:'Rondo 4 vs 1', min:5, max:20, desc:'Possesso rapido con 1 difendente in mezzo.', mats:{palloni:1, cinesini:8}},
                {id:'tec7', name:'Passaggi di prima con movimento continuo', min:6, max:20, desc:'Timing e orientamento del corpo con movimento.', mats:{palloni:2, cinesini:12}},
                {id:'tec8', name:'Ricezione e passaggio su porte colorate', min:6, max:20, desc:'Scelta rapida sul colore chiamato, decidere in fretta.', mats:{palloni:2, porticine:4, cinesini:12}},
                {id:'tec9', name:'Slalom + scarico palla + tiro', min:5, max:20, desc:'Progressione tecnica con finalizzazione.', mats:{palloni:3, conetti:12, porticine:1}},
                {id:'tec10', name:'2 vs 1 in spazi ridotti', min:5, max:20, desc:'Superiorit√† numerica e tempi di passaggio.', mats:{palloni:2, cinesini:8, porticine:2}}
            ],
            situazionale: [
                {id:'sit1', name:'3 vs 2 a salire', min:5, max:20, desc:'Attacco in superiorit√† numerica; chi recupera riparte.', mats:{palloni:2, porticine:2, cinesini:8}},
                {id:'sit2', name:'4 vs 3 con transizione', min:7, max:20, desc:'Cambio fase immediato al recupero palla.', mats:{palloni:2, porticine:2, cinesini:10, pettorine:7}},
                {id:'sit3', name:'Attacco veloce 2 vs 1 con conclusione', min:5, max:20, desc:'Scelta tra portare palla o passare, conclusione obbligatoria.', mats:{palloni:2, porticine:1, cinesini:6}},
                {id:'sit4', name:'3 vs 3 + 2 jolly esterni', min:8, max:20, desc:'Sfrutta ampiezza con jolly laterali fissi.', mats:{palloni:2, porticine:2, cinesini:12, pettorine:8}},
                {id:'sit5', name:'5 vs 4 partendo da met√† campo', min:9, max:20, desc:'Sviluppo in zona offensiva, coperture e scalate.', mats:{palloni:2, porte:2, cinesini:12, pettorine:9}},
                {id:'sit6', name:'2 vs 2 + portieri', min:6, max:20, desc:'Rifinitura e conclusioni rapide con portieri.', mats:{palloni:2, porticine:2, pettorine:4}},
                {id:'sit7', name:'Sovrapposizioni obbligatorie', min:8, max:20, desc:'Tempismo, ampiezza e cross con sovrapposizione.', mats:{palloni:2, cinesini:12, porticine:2}},
                {id:'sit8', name:'Cross e finalizzazione (3 vs 2 in area)', min:7, max:20, desc:'Traversoni e attacco della palla in area.', mats:{palloni:3, porte:1, cinesini:12, paletti:6}},
                {id:'sit9', name:'Attacco da rimessa laterale (3 vs 2)', min:5, max:20, desc:'Schemi rapidi da rimessa laterale.', mats:{palloni:2, porticine:1, cinesini:6}},
                {id:'sit10', name:'Uscita palla da dietro (3 vs 2 pressing alto)', min:7, max:20, desc:'Costruzione pulita sotto pressione e linee di passaggio.', mats:{palloni:3, cinesini:16, porticine:2, pettorine:5}}
            ],
            gioco: [
                {id:'gio1', name:'4 vs 4 (gol valido dopo 3 passaggi)', min:8, max:20, desc:'Gol valido solo dopo 3 passaggi consecutivi.', mats:{palloni:1, porticine:2, pettorine:8}},
                {id:'gio2', name:'3 vs 3 con jolly neutrale', min:7, max:20, desc:'Il jolly gioca con chi ha possesso palla.', mats:{palloni:1, porticine:2, pettorine:7}},
                {id:'gio3', name:'Campo in 3 zone (passare in tutte)', min:8, max:20, desc:'Costruzione paziente, obbligo passaggio in tutte le zone.', mats:{palloni:1, porticine:2, cinesini:12, pettorine:8}},
                {id:'gio4', name:'Gol valido solo con esterno piede', min:8, max:20, desc:'Stimola controllo e coordinazione con esterno.', mats:{palloni:1, porticine:2, pettorine:8}},
                {id:'gio5', name:'Punti doppi se gol nasce da cross', min:10, max:20, desc:'Valorizza gioco sulle fasce e traversoni.', mats:{palloni:2, porte:2, cinesini:12, paletti:4, pettorine:10}},
                {id:'gio6', name:'Gol lampo entro 6 secondi', min:8, max:20, desc:'Transizioni e velocit√† decisionale, vale solo entro 6 secondi.', mats:{palloni:1, porticine:2, cronometro:1, pettorine:8}},
                {id:'gio7', name:'Gol valido solo se segnano tutti', min:8, max:20, desc:'Obiettivo: segnare almeno una volta a testa.', mats:{palloni:1, porticine:2, pettorine:8}},
                {id:'gio8', name:'Partita a 2 porte piccole per squadra', min:8, max:20, desc:'Ricerca di spazi e angoli di tiro diversi.', mats:{palloni:1, porticine:4, pettorine:8}},
                {id:'gio9', name:'Partita con portiere volante', min:10, max:20, desc:'Portiere partecipa al possesso e pu√≤ segnare.', mats:{palloni:1, porte:2, pettorine:10}},
                {id:'gio10', name:'Re del campo', min:9, max:20, desc:'Chi segna resta in campo, chi subisce esce.', mats:{palloni:2, porticine:2, pettorine:9}}
            ],
            partita: [
                {id:'par1', name:'Partita 5 vs 5 (campo ridotto)', min:10, max:20, desc:'Applicazione su campo corto, intensit√† alta con regole ufficiali.', mats:{palloni:1, porticine:4, pettorine:10}},
                {id:'par2', name:'Partita 6 vs 6', min:12, max:20, desc:'Pi√π linee di passaggio e coperture su campo medio.', mats:{palloni:1, porte:2, pettorine:12}},
                {id:'par3', name:'Partita 7 vs 7', min:14, max:20, desc:'Allarga spazi e tempi di gioco, pi√π possesso.', mats:{palloni:1, porte:2, pettorine:14}},
                {id:'par4', name:'Partita 8 vs 8', min:16, max:20, desc:'Quasi formato 9v9, preparazione al gioco ufficiale.', mats:{palloni:1, porte:2, pettorine:16}},
                {id:'par5', name:'Partita 9 vs 9 (regole ufficiali)', min:18, max:20, desc:'Applicazione completa con fuorigioco ultimo terzo.', mats:{palloni:1, porte:2, pettorine:18}},
                {id:'par6', name:'Ruoli a rotazione ogni 5 minuti', min:12, max:20, desc:'Sperimentazione ruoli e responsabilit√† diverse.', mats:{palloni:1, porte:2, cronometro:1, pettorine:12}},
                {id:'par7', name:'Gol doppio dopo 5 passaggi', min:12, max:20, desc:'Premia il possesso paziente e la costruzione.', mats:{palloni:1, porte:2, pettorine:12}},
                {id:'par8', name:'Limite 3 tocchi', min:12, max:20, desc:'Velocit√† di esecuzione e smarcamenti continui.', mats:{palloni:1, porte:2, pettorine:12}},
                {id:'par9', name:'Campo diviso (no palla lunga)', min:12, max:20, desc:'Costruzione dal basso obbligata, no lanci lunghi.', mats:{palloni:1, porte:2, cinesini:12, pettorine:12}},
                {id:'par10', name:'Zona jolly: concludi entro 3 secondi', min:12, max:20, desc:'Finalizzazione rapida in zona designata.', mats:{palloni:1, porte:2, cinesini:8, cronometro:1, pettorine:12}}
            ],
            defaticamento: [
                {id:'def1', name:'Corsa lenta + stretching gambe', min:4, max:20, desc:'Rientro alla calma con corsa leggera e allungamento.', mats:{}},
                {id:'def2', name:'Camminata a coppie (feedback)', min:4, max:20, desc:'Condivisione di ci√≤ che √® piaciuto e imparato.', mats:{}},
                {id:'def3', name:'Stretching a stazioni (player leader)', min:4, max:20, desc:'Un giocatore guida ogni stazione di stretching.', mats:{cinesini:8}},
                {id:'def4', name:'Esercizi di respirazione + rilassamento', min:4, max:20, desc:'In piedi o seduti, focus sul respiro profondo.', mats:{}},
                {id:'def5', name:'Gioco leggero: palla in aria', min:4, max:20, desc:'Cooperazione, la palla non deve cadere a terra.', mats:{palloni:1}},
                {id:'def6', name:'Corsa lenta in cerchio + battimani ritmici', min:4, max:20, desc:'Battimani e respirazione coordinata in gruppo.', mats:{}},
                {id:'def7', name:'Stretching dinamico con musica', min:4, max:20, desc:'Movimenti lenti e controllati a ritmo di musica.', mats:{}},
                {id:'def8', name:'Gamba contro gamba (a coppie)', min:4, max:20, desc:'Allungamenti assistiti in coppia.', mats:{}},
                {id:'def9', name:'Mini-discussione: cosa ho imparato oggi?', min:4, max:20, desc:'Ogni giocatore condivide 1 idea appresa.', mats:{}},
                {id:'def10', name:'Saluto di squadra', min:4, max:20, desc:'Rituale finale positivo con grido di squadra.', mats:{}}
            ]
        };

        const PHASES = [
            {key: 'attivazione', name: 'Attivazione & Riscaldamento (0‚Äì10\')'},
            {key: 'tecnica', name: 'Tecnica di Base (10‚Äì25\')'},
            {key: 'situazionale', name: 'Esercizi Situazionali (25‚Äì45\')'},
            {key: 'gioco', name: 'Giochi a Tema (45‚Äì65\')'},
            {key: 'partita', name: 'Partita/Applicazione (65‚Äì85\')'},
            {key: 'defaticamento', name: 'Defaticamento & Feedback (85‚Äì90\')'}
        ];

        const MATERIAL_KEYS = ['palloni','cinesini','conetti','paletti','aste','porticine','porte','ostacoli','scale','pettorine','fischietto','cronometro','lavagnetta','nastro'];

        // Storage per esercizi personalizzati
        let customExercises = {};
        let lastPdfBlob = null;
        let tempState = null;
        
        // Storage per schemi tattici
        let tacticalDrawings = {};
        let tacticalStates = {};

        function getPlayers() {
            const el = document.getElementById('presenti');
            let v = parseInt(el.value, 10);
            if (isNaN(v)) v = 12;
            v = Math.max(4, Math.min(20, v));
            el.value = v;
            return v;
        }

        function renderPhases() {
            const container = document.getElementById('phases-container');
            if (!container) {
                console.error('Container phases-container non trovato!');
                return;
            }
            
            const presenti = getPlayers();
            container.innerHTML = '';
            
            PHASES.forEach(phase => {
                // Trova esercizi compatibili dal database
                const availableExercises = DB[phase.key].filter(ex => presenti >= ex.min && presenti <= ex.max);
                
                const phaseDiv = document.createElement('div');
                phaseDiv.className = 'phase';
                
                let optionsHtml = '<option value="">-- Seleziona esercizio --</option>';
                availableExercises.forEach(ex => {
                    optionsHtml += `<option value="${ex.id}">${ex.name}</option>`;
                });
                
                // Aggiungi opzione per esercizio personalizzato
                optionsHtml += `<option value="custom-${phase.key}">+ Esercizio personalizzato</option>`;
                
                // Aggiungi esercizio personalizzato esistente se presente
                if (customExercises[phase.key]) {
                    const custom = customExercises[phase.key];
                    optionsHtml += `<option value="custom-${phase.key}-saved">${custom.name} <span class="custom-exercise-badge">CUSTOM</span></option>`;
                }
                
                phaseDiv.innerHTML = `
                    <div class="phase-header">${phase.name}</div>
                    <div style="font-size: 0.9rem; color: #666; margin-bottom: 10px;">
                        ${availableExercises.length} esercizi disponibili per ${presenti} giocatori
                    </div>
                    <select id="select-${phase.key}" data-phase="${phase.key}">
                        ${optionsHtml}
                    </select>
                    <div id="details-${phase.key}"></div>
                    <div class="custom-form-buttons" style="margin-top: 10px;">
                        <button class="btn-small primary" onclick="toggleTacticalEditor('${phase.key}')">‚öΩ Schema tattico</button>
                    </div>
                    <div id="tactical-editor-${phase.key}" class="tactical-editor">
                        <h4>Schema Tattico - ${phase.name}</h4>
                        <div class="tactical-tools">
                            <div class="tool-group">
                                <label>Strumento</label>
                                <div class="tool-buttons">
                                    <button class="tool-btn active" data-tool="brush" onclick="setTool('${phase.key}', 'brush')">‚úèÔ∏è Pennello</button>
                                    <button class="tool-btn" data-tool="eraser" onclick="setTool('${phase.key}', 'eraser')">üßΩ Gomma</button>
                                </div>
                            </div>
                            <div class="tool-group">
                                <label>Colore</label>
                                <div class="color-palette">
                                    <div class="color-btn color-red active" data-color="#ff0000" onclick="setColor('${phase.key}', '#ff0000')"></div>
                                    <div class="color-btn color-blue" data-color="#0000ff" onclick="setColor('${phase.key}', '#0000ff')"></div>
                                    <div class="color-btn color-yellow" data-color="#ffff00" onclick="setColor('${phase.key}', '#ffff00')"></div>
                                    <div class="color-btn color-white" data-color="#ffffff" onclick="setColor('${phase.key}', '#ffffff')"></div>
                                    <div class="color-btn color-black" data-color="#000000" onclick="setColor('${phase.key}', '#000000')"></div>
                                    <div class="color-btn color-orange" data-color="#ffa500" onclick="setColor('${phase.key}', '#ffa500')"></div>
                                </div>
                            </div>
                            <div class="tool-group">
                                <label>Spessore</label>
                                <div class="brush-size">
                                    <input type="range" id="brush-size-${phase.key}" min="2" max="20" value="4" onchange="setBrushSize('${phase.key}', this.value)">
                                    <span id="brush-size-value-${phase.key}">4px</span>
                                </div>
                            </div>
                        </div>
                        <div class="tactical-canvas-container">
                            <canvas id="canvas-${phase.key}" class="tactical-canvas"></canvas>
                        </div>
                        <div class="tactical-actions">
                            <button class="btn-small secondary" onclick="redrawField('${phase.key}')">üîÑ Campo base</button>
                            <button class="btn-small secondary" onclick="clearTacticalCanvas('${phase.key}')">üóëÔ∏è Pulisci campo</button>
                            <button class="btn-small primary" onclick="saveTacticalDrawing('${phase.key}')">üíæ Salva schema</button>
                        </div>
                        <div id="tactical-status-${phase.key}" class="tactical-status">
                            Pronto per disegnare - Usa il pennello per tracciare movimenti e posizioni
                        </div>
                    </div>
                    <div id="custom-form-${phase.key}" class="custom-form">
                        <h4>Crea Esercizio Personalizzato</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Nome esercizio</label>
                                <input type="text" id="custom-name-${phase.key}" placeholder="es. Passaggi con ostacoli">
                            </div>
                            <div class="form-group">
                                <label>Descrizione</label>
                                <textarea id="custom-desc-${phase.key}" rows="3" placeholder="Descrivi l'esercizio nel dettaglio..."></textarea>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Materiale necessario</label>
                            <div class="materials-selector" id="materials-${phase.key}">
                                ${MATERIAL_KEYS.map(key => `
                                    <div class="material-item">
                                        <label>${labelFor(key)}</label>
                                        <input type="number" id="mat-${key}-${phase.key}" min="0" max="99" value="0">
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div class="custom-form-buttons">
                            <button class="btn-small primary" onclick="saveCustomExercise('${phase.key}')">Salva</button>
                            <button class="btn-small secondary" onclick="cancelCustomExercise('${phase.key}')">Annulla</button>
                        </div>
                    </div>
                `;
                
                container.appendChild(phaseDiv);
            });
            
            // Aggiungi event listener ai select
            const selects = container.querySelectorAll('select');
            selects.forEach(select => {
                select.addEventListener('change', function() {
                    const phaseKey = this.dataset.phase;
                    const value = this.value;
                    
                    if (value === `custom-${phaseKey}`) {
                        showCustomForm(phaseKey);
                        updateExerciseDetails(phaseKey, '');
                    } else if (value === `custom-${phaseKey}-saved`) {
                        hideCustomForm(phaseKey);
                        updateExerciseDetails(phaseKey, value);
                    } else {
                        hideCustomForm(phaseKey);
                        updateExerciseDetails(phaseKey, value);
                    }
                    
                    updateTotalMaterials();
                    updateValidityStatus();
                });
            });
        }

        function showCustomForm(phaseKey) {
            const form = document.getElementById(`custom-form-${phaseKey}`);
            if (form) {
                form.classList.add('active');
            }
        }

        function hideCustomForm(phaseKey) {
            const form = document.getElementById(`custom-form-${phaseKey}`);
            if (form) {
                form.classList.remove('active');
            }
        }

        function saveCustomExercise(phaseKey) {
            const name = document.getElementById(`custom-name-${phaseKey}`).value.trim();
            const desc = document.getElementById(`custom-desc-${phaseKey}`).value.trim();
            
            if (!name || !desc) {
                alert('Inserire nome e descrizione dell\'esercizio');
                return;
            }
            
            // Raccogli materiali
            const mats = {};
            MATERIAL_KEYS.forEach(key => {
                const qty = parseInt(document.getElementById(`mat-${key}-${phaseKey}`).value) || 0;
                if (qty > 0) {
                    mats[key] = qty;
                }
            });
            
            // Salva esercizio personalizzato
            customExercises[phaseKey] = {
                id: `custom-${phaseKey}-saved`,
                name: name,
                desc: desc,
                mats: mats,
                custom: true
            };
            
            // Aggiorna la UI
            renderPhases();
            
            // Seleziona automaticamente l'esercizio appena creato
            const select = document.getElementById(`select-${phaseKey}`);
            if (select) {
                select.value = `custom-${phaseKey}-saved`;
                updateExerciseDetails(phaseKey, `custom-${phaseKey}-saved`);
                updateTotalMaterials();
                updateValidityStatus();
            }
        }

        function cancelCustomExercise(phaseKey) {
            const select = document.getElementById(`select-${phaseKey}`);
            if (select) {
                select.value = '';
            }
            
            hideCustomForm(phaseKey);
            updateExerciseDetails(phaseKey, '');
            updateTotalMaterials();
            updateValidityStatus();
        }

        function getExerciseById(id) {
            // Prima controlla negli esercizi personalizzati
            for (const phaseKey in customExercises) {
                if (customExercises[phaseKey].id === id) {
                    return customExercises[phaseKey];
                }
            }
            
            // Poi nel database normale
            for (const phaseKey in DB) {
                const found = DB[phaseKey].find(ex => ex.id === id);
                if (found) return found;
            }
            return null;
        }

        function resolveMaterials(mats, presenti) {
            const resolved = {};
            for (const [key, value] of Object.entries(mats)) {
                if (typeof value === 'string') {
                    switch (value) {
                        case 'per_giocatore':
                            resolved[key] = presenti;
                            break;
                        case 'per_coppia':
                            resolved[key] = Math.ceil(presenti / 2);
                            break;
                        case 'giocatori_meno_1':
                            resolved[key] = Math.max(presenti - 1, 1);
                            break;
                        default:
                            resolved[key] = 0;
                    }
                } else {
                    resolved[key] = value;
                }
            }
            return resolved;
        }

        function labelFor(key) {
            const labels = {
                palloni: 'Palloni',
                cinesini: 'Cinesini',
                conetti: 'Conetti',
                paletti: 'Paletti',
                aste: 'Aste',
                porticine: 'Porticine',
                porte: 'Porte',
                ostacoli: 'Ostacoli',
                scale: 'Scale di velocit√†',
                pettorine: 'Pettorine',
                fischietto: 'Fischietto',
                cronometro: 'Cronometro',
                lavagnetta: 'Lavagnetta',
                nastro: 'Nastro segnaletico'
            };
            return labels[key] || key;
        }

        function updateExerciseDetails(phaseKey, exerciseId) {
            const detailsDiv = document.getElementById(`details-${phaseKey}`);
            
            if (!exerciseId) {
                detailsDiv.innerHTML = '';
                return;
            }
            
            const exercise = getExerciseById(exerciseId);
            if (!exercise) {
                detailsDiv.innerHTML = '';
                return;
            }
            
            const presenti = getPlayers();
            const resolvedMats = resolveMaterials(exercise.mats, presenti);
            
            let matChips = '';
            for (const [key, qty] of Object.entries(resolvedMats)) {
                if (qty > 0) {
                    matChips += `<span class="mat-chip">${labelFor(key)}: ${qty}</span> `;
                }
            }
            
            const customBadge = exercise.custom ? '<span class="custom-exercise-badge">PERSONALIZZATO</span>' : '';
            
            detailsDiv.innerHTML = `
                <div class="exercise-details">
                    <div class="exercise-desc">${exercise.desc} ${customBadge}</div>
                    <div class="exercise-mats">${matChips}</div>
                </div>
            `;
        }

        function updateTotalMaterials() {
            const presenti = getPlayers();
            const totals = {};
            let maxPalloni = 0;
            
            // Inizializza tutte le chiavi a 0
            MATERIAL_KEYS.forEach(k => totals[k] = 0);
            
            PHASES.forEach(phase => {
                const select = document.getElementById(`select-${phase.key}`);
                if (!select || !select.value) return;
                
                const exercise = getExerciseById(select.value);
                if (exercise) {
                    const resolved = resolveMaterials(exercise.mats, presenti);
                    
                    for (const [key, qty] of Object.entries(resolved)) {
                        if (key === 'palloni') {
                            maxPalloni = Math.max(maxPalloni, qty);
                        } else {
                            totals[key] = (totals[key] || 0) + qty;
                        }
                    }
                }
            });
            
            // Imposta palloni come massimo, non somma
            if (maxPalloni > 0) {
                totals.palloni = maxPalloni;
            }
            
            // Assicura minimi per allenamento base
            if (totals.palloni < presenti) {
                totals.palloni = presenti;
            }
            if (totals.pettorine < presenti) {
                totals.pettorine = presenti;
            }
            
            const container = document.getElementById('total-materials');
            const nonZeroTotals = Object.entries(totals).filter(([key, qty]) => qty > 0);
            
            if (nonZeroTotals.length === 0) {
                container.innerHTML = '<div class="guide-text">Seleziona gli esercizi per vedere il materiale necessario</div>';
                return;
            }
            
            let chips = '';
            nonZeroTotals.forEach(([key, qty]) => {
                chips += `<span class="total-chip">${labelFor(key)}: ${qty}</span> `;
            });
            
            container.innerHTML = chips;
        }

        function updateValidityStatus() {
            const validityElement = document.getElementById('validity-status');
            const selectedCount = PHASES.filter(phase => {
                const select = document.getElementById(`select-${phase.key}`);
                if (!select || !select.value) return false;
                // Considera selezionato solo se esiste realmente un esercizio (anche personalizzato salvato)
                return !!getExerciseById(select.value);
            }).length;
            
            validityElement.textContent = `${selectedCount}/6 esercizi selezionati`;
            
            if (selectedCount === 6) {
                validityElement.className = 'validity-status validity-complete';
                validityElement.textContent += ' ¬∑ pronto per PDF';
            } else {
                validityElement.className = 'validity-status validity-incomplete';
            }
        }

        function autofillExercises() {
            const presenti = getPlayers();
            
            PHASES.forEach(phase => {
                const select = document.getElementById(`select-${phase.key}`);
                const availableExercises = DB[phase.key].filter(ex => presenti >= ex.min && presenti <= ex.max);
                
                if (availableExercises.length > 0) {
                    // Seleziona un esercizio casuale invece del primo
                    const randomIndex = Math.floor(Math.random() * availableExercises.length);
                    const randomExercise = availableExercises[randomIndex];
                    select.value = randomExercise.id;
                    hideCustomForm(phase.key);
                    updateExerciseDetails(phase.key, randomExercise.id);
                }
            });
            
            updateTotalMaterials();
            updateValidityStatus();
        }

        function clearSelections() {
            PHASES.forEach(phase => {
                const select = document.getElementById(`select-${phase.key}`);
                if (select) {
                    select.value = '';
                    hideCustomForm(phase.key);
                    updateExerciseDetails(phase.key, '');
                }
            });
            updateTotalMaterials();
            updateValidityStatus();
        }


        async function exportPDF() {
            const meta = {
                presenti: getPlayers(),
                data: document.getElementById('data').value,
                ora: document.getElementById('ora').value,
                campo: document.getElementById('campo').value,
                mister: document.getElementById('mister').value,
                categoria: document.getElementById('categoria').value,
                note: document.getElementById('note').value
            };
            
            if (!meta.presenti || meta.presenti < 4 || meta.presenti > 20) {
                alert('Inserire un numero di presenti valido (4-20).');
                return;
            }
            
            // Salva tutti gli schemi tattici prima dell'esportazione
            PHASES.forEach(phase => {
                const canvas = document.getElementById(`canvas-${phase.key}`);
                if (canvas) {
                    tacticalDrawings[phase.key] = canvas.toDataURL('image/png');
                }
            });
            
            // Genera PDF con immagini
            const pdfString = await buildEnhancedPDF(meta);
            const blob = new Blob([pdfString], {type: 'application/pdf'});
            lastPdfBlob = blob;
            
            // Non scaricare pi√π il PDF direttamente, sar√† incluso nello ZIP
            // Passa il blob del PDF alla funzione che genera lo ZIP
            const dateStr = meta.data || new Date().toISOString().split('T')[0];
            const filename = `Mister20_${dateStr}_${meta.categoria}_${meta.presenti}p.pdf`;
            
            // Verifica se ci sono schemi tattici
            const hasTacticalDrawings = Object.keys(tacticalDrawings).length > 0;
            
            if (hasTacticalDrawings) {
                // Se ci sono schemi, includi il PDF nello ZIP con gli schemi
                generateTacticalImagesWithPDF(meta, blob, filename);
            } else {
                // Se non ci sono schemi, scarica solo il PDF
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        }

        function aggregateTotalsForPrint(presenti) {
            const totals = {};
            let maxPalloni = 0;
            
            // Inizializza tutte le chiavi
            MATERIAL_KEYS.forEach(k => totals[k] = 0);
            
            PHASES.forEach(phase => {
                const select = document.getElementById(`select-${phase.key}`);
                if (!select || !select.value) return;
                const exercise = getExerciseById(select.value);
                if (!exercise) return;
                const resolved = resolveMaterials(exercise.mats, presenti);
                for (const [key, qty] of Object.entries(resolved)) {
                    if (key === 'palloni') {
                        maxPalloni = Math.max(maxPalloni, qty);
                    } else {
                        totals[key] = (totals[key] || 0) + qty;
                    }
                }
            });
            
            // Imposta palloni come massimo
            if (maxPalloni > 0) {
                totals.palloni = maxPalloni;
            }
            
            // Assicura minimi
            if (totals.palloni < presenti) {
                totals.palloni = presenti;
            }
            if (totals.pettorine < presenti) {
                totals.pettorine = presenti;
            }
            
            // Rimuovi zeri
            Object.keys(totals).forEach(k => {
                if (totals[k] === 0) delete totals[k];
            });
            
            return totals;
        }

        async function buildEnhancedPDF(meta) {
            const lines = [];
            
            // Titolo con stile migliorato
            lines.push('Mister 2.0 ‚Äî Scheda Allenamento');
            lines.push('');
            
            // Dati allenamento compatti per prima pagina
            const dataStr = meta.data ? new Date(meta.data + 'T00:00:00').toLocaleDateString('it-IT') : '___';
            const oraStr = meta.ora || '___';
            const campoStr = meta.campo || '___';
            lines.push(`Data: ${dataStr}   Ora: ${oraStr}   Campo: ${campoStr}`);
            
            const categoriaStr = meta.categoria || '___';
            const misterStr = meta.mister || '___';
            lines.push(`Categoria: ${categoriaStr}   Mister: ${misterStr}   Presenti: ${meta.presenti}`);
            
            if (meta.note && meta.note.trim()) {
                lines.push('');
                const noteLines = wrapText(`Note: ${meta.note.trim()}`, 85);
                lines.push(...noteLines);
            }
            
            lines.push('');
            lines.push('FASI & ESERCIZI:');
            lines.push('');
            
            // Fasi ed esercizi compatti
            PHASES.forEach((phase, index) => {
                const select = document.getElementById(`select-${phase.key}`);
                const exerciseId = select ? select.value : '';
                
                lines.push(`${index + 1}. ${phase.name}:`);
                
                const exercise = exerciseId ? getExerciseById(exerciseId) : null;
                    if (exercise) {
                        const customLabel = exercise.custom ? ' [PERSONALIZZATO]' : '';
                        lines.push(`   Esercizio: ${exercise.name}${customLabel}`);
                    
                    const descLines = wrapText(`   Descrizione: ${exercise.desc}`, 80);
                        lines.push(...descLines);
                        
                        const resolved = resolveMaterials(exercise.mats, meta.presenti);
                        const matList = [];
                        for (const [key, qty] of Object.entries(resolved)) {
                            if (qty > 0) {
                                matList.push(`${labelFor(key)} ${qty}`);
                            }
                        }
                        
                        if (matList.length > 0) {
                        const matLines = wrapText(`   Materiale: ${matList.join(', ')}`, 80);
                            lines.push(...matLines);
                        }
                    
                    // Riferimento schema tattico
                    if (tacticalDrawings[phase.key]) {
                        lines.push('   Schema tattico: Presente (file separato)');
                    }
                } else {
                    lines.push('   ‚Äî (non selezionato) ‚Äî');
                }
                
                lines.push('');
            });
            
            // Materiale totale compatto
            const totals = aggregateTotalsForPrint(meta.presenti);
            if (Object.keys(totals).length > 0) {
                lines.push('MATERIALE TOTALE:');
                const totalList = [];
                for (const [key, qty] of Object.entries(totals)) {
                    if (qty > 0) {
                        totalList.push(`${labelFor(key)} ${qty}`);
                    }
                }
                
                if (totalList.length > 0) {
                    const totalLines = wrapText(totalList.join(', '), 85);
                    lines.push(...totalLines);
                }
            }
            
            // Crediti
            lines.push('');
            lines.push('Generato con Mister 2.0 by 2M Digital Consulting srls');
            
            // Genera PDF con immagini degli schemi tattici
            return buildPDFWithTacticalImages(lines, meta);
        }
        
        function buildPDFWithImages(lines, meta) {
            const hasTacticalDrawings = Object.keys(tacticalDrawings).length > 0;
            let objCount = 4; // Catalog, Pages, Font1, Font2
            const imageObjects = [];
            
            // Aggiungi oggetti per le immagini se presenti
            if (hasTacticalDrawings) {
                Object.values(tacticalDrawings).forEach((imageData, index) => {
                    if (imageData) {
                        objCount++;
                        imageObjects.push({
                            id: objCount,
                            data: imageData.split(',')[1] // Rimuovi data:image/png;base64,
                        });
                    }
                });
            }
            
            // Calcola numero di pagine necessarie
            const pageCount = hasTacticalDrawings ? 2 : 1;
            const pageObjects = [];
            
            // Pagina 1: Contenuto principale
            objCount++;
            pageObjects.push({
                id: objCount,
                content: lines
            });
            
            // Pagina 2: Schemi tattici (se presenti)
            if (hasTacticalDrawings) {
                objCount++;
                const tacticalLines = [];
                tacticalLines.push('SCHEMI TATTICI');
                tacticalLines.push('');
                
                PHASES.forEach((phase, index) => {
                    if (tacticalDrawings[phase.key]) {
                        tacticalLines.push(`${index + 1}. ${phase.name}:`);
                        tacticalLines.push('   Schema tattico presente');
                        tacticalLines.push('');
                    }
                });
                
                pageObjects.push({
                    id: objCount,
                    content: tacticalLines
                });
            }
            
            const pdfContent = [
                '%PDF-1.4',
                '1 0 obj',
                '<<',
                '/Type /Catalog',
                '/Pages 2 0 R',
                '>>',
                'endobj',
                '',
                '2 0 obj',
                '<<',
                '/Type /Pages',
                `/Kids [${pageObjects.map(p => `${p.id} 0 R`).join(' ')}]`,
                `/Count ${pageCount}`,
                '>>',
                'endobj',
                '',
                '3 0 obj',
                '<<',
                '/Type /Font',
                '/Subtype /Type1',
                '/BaseFont /Helvetica',
                '>>',
                'endobj',
                '',
                '4 0 obj',
                '<<',
                '/Type /Font',
                '/Subtype /Type1',
                '/BaseFont /Helvetica-Bold',
                '>>',
                'endobj'
            ];
            
            // Aggiungi oggetti immagini
            imageObjects.forEach((img, index) => {
                pdfContent.push('');
                pdfContent.push(`${img.id} 0 obj`);
                pdfContent.push('<<');
                pdfContent.push('/Type /XObject');
                pdfContent.push('/Subtype /Image');
                pdfContent.push('/Width 200');
                pdfContent.push('/Height 140');
                pdfContent.push('/ColorSpace /DeviceRGB');
                pdfContent.push('/BitsPerComponent 8');
                pdfContent.push('/Filter /FlateDecode');
                pdfContent.push(`/Length ${img.data.length}`);
                pdfContent.push('>>');
                pdfContent.push('stream');
                pdfContent.push(img.data);
                pdfContent.push('endstream');
                pdfContent.push('endobj');
            });
            
            // Aggiungi oggetti pagine
            pageObjects.forEach((page, index) => {
                const resources = hasTacticalDrawings && index === 1 ? 
                    `<< /Font << /F1 3 0 R /F2 4 0 R >> /XObject << ${imageObjects.map((img, i) => `/IMG${i} ${img.id} 0 R`).join(' ')} >> >>` :
                    '<< /Font << /F1 3 0 R /F2 4 0 R >> >>';
                
                pdfContent.push('');
                pdfContent.push(`${page.id} 0 obj`);
                pdfContent.push('<<');
                pdfContent.push('/Type /Page');
                pdfContent.push('/Parent 2 0 R');
                pdfContent.push('/MediaBox [0 0 595.28 841.89]');
                pdfContent.push(`/Resources ${resources}`);
                pdfContent.push(`/Contents ${objCount + index + 1} 0 R`);
                pdfContent.push('>>');
                pdfContent.push('endobj');
            });
            
            // Aggiungi contenuti delle pagine
            pageObjects.forEach((page, index) => {
                let content;
                if (hasTacticalDrawings && index === 1) {
                    // Pagina 2 con immagini
                    content = buildTacticalPageContent(page.content, imageObjects);
                        } else {
                    // Pagina 1 normale
                    content = buildSimplePageContent(page.content);
                }
                
                pdfContent.push('');
                pdfContent.push(`${objCount + index + 1} 0 obj`);
                pdfContent.push('<<');
                pdfContent.push(`/Length ${content.length}`);
                pdfContent.push('>>');
                pdfContent.push('stream');
                pdfContent.push(content);
                pdfContent.push('endstream');
                pdfContent.push('endobj');
            });
            
            // Xref table
            const xrefPos = pdfContent.join('\n').length + 1;
            pdfContent.push('');
            pdfContent.push('xref');
            pdfContent.push(`0 ${objCount + pageCount + 1}`);
            pdfContent.push('0000000000 65535 f ');
            
            let currentPos = 9;
            for (let i = 1; i <= objCount + pageCount; i++) {
                pdfContent.push(`${currentPos.toString().padStart(10, '0')} 00000 n `);
                currentPos += 100;
            }
            
            // Trailer
            pdfContent.push('trailer');
            pdfContent.push('<<');
            pdfContent.push(`/Size ${objCount + pageCount + 1}`);
            pdfContent.push('/Root 1 0 R');
            pdfContent.push('>>');
            pdfContent.push('startxref');
            pdfContent.push(xrefPos.toString());
            pdfContent.push('%%EOF');
            
            return pdfContent.join('\n');
        }
        
        function buildSimplePageContent(lines) {
            let content = '';
            let currentY = 800;
            
            // Header con sfondo colorato
            content += 'q\n';
            content += '0.1 0.6 0.4 rg\n'; // Verde Mister 2.0
            content += '0 750 595.28 50 re\n'; // Rettangolo di sfondo
            content += 'f\n';
            content += 'Q\n';
            
            // Titolo principale
            content += 'BT\n';
            content += '/F2 24 Tf\n'; // Font bold grande
            content += '1 1 1 rg\n'; // Testo bianco
            content += '50 765 Td\n';
            content += `(${escapeString('Mister 2.0 ‚Äî Scheda Allenamento')}) Tj\n`;
            content += 'ET\n';
            
            currentY = 720;
            
            // Dati allenamento con stile
            content += 'BT\n';
            content += '/F1 12 Tf\n';
            content += '0.2 0.2 0.2 rg\n'; // Grigio scuro
            content += `50 ${currentY} Td\n`;
            
            // Prima riga dati
            const dataLine = lines[2]; // "Data: ..."
            content += `(${escapeString(dataLine)}) Tj\n`;
            content += 'ET\n';
            
            currentY -= 16;
            content += 'BT\n';
            content += '/F1 12 Tf\n';
            content += '0.2 0.2 0.2 rg\n';
            content += `50 ${currentY} Td\n`;
            
            // Seconda riga dati
            const categoryLine = lines[3]; // "Categoria: ..."
            content += `(${escapeString(categoryLine)}) Tj\n`;
            content += 'ET\n';
            
            currentY -= 20;
            
            // Note se presenti
            let noteIndex = 4;
            if (lines[noteIndex] && lines[noteIndex].includes('Note:')) {
                content += 'BT\n';
                content += '/F2 11 Tf\n';
                content += '0.1 0.6 0.4 rg\n'; // Verde per "Note:"
                content += `50 ${currentY} Td\n`;
                content += `(${escapeString(lines[noteIndex])}) Tj\n`;
                content += 'ET\n';
                currentY -= 16;
                noteIndex++;
            }
            
            currentY -= 10;
            
            // Separatore decorativo
            content += 'BT\n';
            content += '/F1 10 Tf\n';
            content += '0.1 0.6 0.4 rg\n';
            content += `50 ${currentY} Td\n`;
            content += `(${escapeString('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê')}) Tj\n`;
            content += 'ET\n';
            
            currentY -= 20;
            
            // Titolo sezione
            content += 'BT\n';
            content += '/F2 16 Tf\n';
            content += '0.1 0.6 0.4 rg\n';
            content += `50 ${currentY} Td\n`;
            content += `(${escapeString('FASI & ESERCIZI')}) Tj\n`;
            content += 'ET\n';
            
            currentY -= 20;
            content += 'BT\n';
            content += '/F1 10 Tf\n';
            content += '0.1 0.6 0.4 rg\n';
            content += `50 ${currentY} Td\n`;
            content += `(${escapeString('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê')}) Tj\n`;
            content += 'ET\n';
            
            currentY -= 15;
            
            // Fasi ed esercizi
            let phaseIndex = noteIndex + 2; // Salta righe vuote
            for (let i = 0; i < 6; i++) {
                if (phaseIndex >= lines.length) break;
                
                // Nome fase
                content += 'BT\n';
                content += '/F2 12 Tf\n';
                content += '0.1 0.6 0.4 rg\n';
                content += '50 ' + currentY + ' Td\n';
                content += '(' + escapeString(lines[phaseIndex]) + ') Tj\n';
                content += 'ET\n';
                currentY -= 14;
                phaseIndex++;
                
                // Esercizio
                if (phaseIndex < lines.length && lines[phaseIndex].includes('Esercizio:')) {
                    content += 'BT\n';
                    content += '/F1 10 Tf\n';
                    content += '0.2 0.2 0.2 rg\n';
                    content += '60 ' + currentY + ' Td\n';
                    content += '(' + escapeString(lines[phaseIndex]) + ') Tj\n';
                    content += 'ET\n';
                    currentY -= 12;
                    phaseIndex++;
                }
                
                // Descrizione
                while (phaseIndex < lines.length && lines[phaseIndex].includes('Descrizione:')) {
                    content += 'BT\n';
                    content += '/F1 9 Tf\n';
                    content += '0.3 0.3 0.3 rg\n';
                    content += '60 ' + currentY + ' Td\n';
                    content += '(' + escapeString(lines[phaseIndex]) + ') Tj\n';
                    content += 'ET\n';
                    currentY -= 11;
                    phaseIndex++;
                }
                
                // Materiale
                while (phaseIndex < lines.length && lines[phaseIndex].includes('Materiale:')) {
                    content += 'BT\n';
                    content += '/F1 9 Tf\n';
                    content += '0.4 0.2 0.2 rg\n';
                    content += '60 ' + currentY + ' Td\n';
                    content += '(' + escapeString(lines[phaseIndex]) + ') Tj\n';
                    content += 'ET\n';
                    currentY -= 11;
                    phaseIndex++;
                }
                
                // Schema tattico
                if (phaseIndex < lines.length && lines[phaseIndex].includes('Schema tattico:')) {
                    content += 'BT\n';
                    content += '/F1 9 Tf\n';
                    content += '0.1 0.6 0.4 rg\n';
                    content += '60 ' + currentY + ' Td\n';
                    content += '(' + escapeString(lines[phaseIndex]) + ') Tj\n';
                    content += 'ET\n';
                    currentY -= 11;
                    phaseIndex++;
                }
                
                // Salta righe vuote
                while (phaseIndex < lines.length && lines[phaseIndex].trim() === '') {
                    phaseIndex++;
                }
                
                currentY -= 3;
            }
            
            // Materiale totale
            while (phaseIndex < lines.length && !lines[phaseIndex].includes('MATERIALE TOTALE')) {
                phaseIndex++;
            }
            
            if (phaseIndex < lines.length) {
                currentY -= 10;
                content += 'BT\n';
                content += '/F1 10 Tf\n';
                content += '0.1 0.6 0.4 rg\n';
                content += `50 ${currentY} Td\n`;
                content += `(${escapeString('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê')}) Tj\n`;
                content += 'ET\n';
                
                currentY -= 15;
                content += 'BT\n';
                content += '/F2 12 Tf\n';
                content += '0.1 0.6 0.4 rg\n';
                content += `50 ${currentY} Td\n`;
                content += `(${escapeString('MATERIALE TOTALE')}) Tj\n`;
                content += 'ET\n';
                
                currentY -= 15;
                content += 'BT\n';
                content += '/F1 10 Tf\n';
                content += '0.1 0.6 0.4 rg\n';
                content += `50 ${currentY} Td\n`;
                content += `(${escapeString('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê')}) Tj\n`;
                content += 'ET\n';
                
                currentY -= 12;
                phaseIndex++;
                
                // Lista materiali
                while (phaseIndex < lines.length && !lines[phaseIndex].includes('Generato con')) {
                    content += 'BT\n';
                    content += '/F1 10 Tf\n';
                    content += '0.2 0.2 0.2 rg\n';
                    content += '50 ' + currentY + ' Td\n';
                    content += '(' + escapeString(lines[phaseIndex]) + ') Tj\n';
                    content += 'ET\n';
                    currentY -= 12;
                    phaseIndex++;
                }
            }
            
            // Crediti
            if (phaseIndex < lines.length) {
                currentY -= 15;
                content += 'BT\n';
                content += '/F1 8 Tf\n';
                content += '0.5 0.5 0.5 rg\n';
                content += '50 ' + currentY + ' Td\n';
                content += '(' + escapeString(lines[phaseIndex]) + ') Tj\n';
                content += 'ET\n';
            }
            
            return content;
        }
        
        function buildTacticalPageContent(lines, imageObjects) {
            let content = '';
            let currentY = 800;
            
            // Header con sfondo colorato
            content += 'q\n';
            content += '0.1 0.6 0.4 rg\n'; // Verde Mister 2.0
            content += '0 750 595.28 50 re\n'; // Rettangolo di sfondo
            content += 'f\n';
            content += 'Q\n';
            
            // Titolo principale
            content += 'BT\n';
            content += '/F2 20 Tf\n'; // Font bold
            content += '1 1 1 rg\n'; // Testo bianco
            content += '50 765 Td\n';
            content += `(${escapeString('SCHEMI TATTICI')}) Tj\n`;
            content += 'ET\n';
            
            currentY = 720;
            
            // Separatore decorativo
            content += 'BT\n';
            content += '/F1 10 Tf\n';
            content += '0.1 0.6 0.4 rg\n';
            content += `50 ${currentY} Td\n`;
            content += `(${escapeString('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê')}) Tj\n`;
            content += 'ET\n';
            
            currentY -= 25;
            
            // Aggiungi le immagini degli schemi tattici
            let imageIndex = 0;
            PHASES.forEach((phase, index) => {
                if (tacticalDrawings[phase.key] && imageObjects[imageIndex]) {
                    // Nome della fase
                    content += 'BT\n';
                    content += '/F2 14 Tf\n';
                    content += '0.1 0.6 0.4 rg\n';
                    content += `50 ${currentY} Td\n`;
                    content += `(${escapeString(`${index + 1}. ${phase.name}`)}) Tj\n`;
                    content += 'ET\n';
                    
                    currentY -= 20;
                    
                    // Aggiungi immagine
                    const imageWidth = 350;
                    const imageHeight = 245;
                    const imageX = (595.28 - imageWidth) / 2;
                    
                    content += 'ET\n';
                    content += `q ${imageWidth} 0 0 ${imageHeight} ${imageX} ${currentY - 20} cm /IMG${imageIndex} Do Q\n`;
                    content += 'BT\n';
                    content += '/F1 10 Tf\n';
                    content += '0.3 0.3 0.3 rg\n';
                    content += `50 ${currentY - 270} Td\n`;
                    content += `(${escapeString('Schema tattico presente')}) Tj\n`;
                    content += 'ET\n';
                    
                    currentY -= 300;
                    imageIndex++;
                    
                    // Spazio tra le immagini
                    if (imageIndex < imageObjects.length) {
                        currentY -= 20;
                    }
                }
            });
            
            return content;
        }

        function wrapText(text, maxChars = 95) {
            if (text.length <= maxChars) return [text];
            
            const words = text.split(' ');
            const lines = [];
            let currentLine = '';
            
            words.forEach(word => {
                if ((currentLine + ' ' + word).length <= maxChars) {
                    currentLine += (currentLine ? ' ' : '') + word;
                } else {
                    if (currentLine) lines.push(currentLine);
                    currentLine = word;
                }
            });
            
            if (currentLine) lines.push(currentLine);
            return lines;
        }

        function buildPDFWithTacticalImages(lines, meta) {
            const hasTacticalDrawings = Object.keys(tacticalDrawings).length > 0;
            
            if (!hasTacticalDrawings) {
                // Se non ci sono schemi tattici, usa il PDF semplice
                return buildSimplePDFWithDesign(lines);
            }
            
            // Non genera pi√π automaticamente le immagini qui
            // Sar√† gestito dalla funzione exportPDF()
            
            // Genera PDF semplice con riferimenti agli schemi
            return buildSimplePDFWithDesign(lines);
        }
        
        function generateTacticalImages(meta) {
            const hasDrawings = Object.keys(tacticalDrawings).length > 0;
            if (!hasDrawings) return;
            
            // Crea un ZIP con tutti gli schemi
            const zip = new JSZip();
            let count = 0;
            
            PHASES.forEach((phase, index) => {
                if (tacticalDrawings[phase.key]) {
                    count++;
                    const canvas = document.getElementById(`canvas-${phase.key}`);
                    if (canvas) {
                        // Crea una copia del canvas per aggiungere il testo
                        const tempCanvas = document.createElement('canvas');
                        const tempCtx = tempCanvas.getContext('2d');
                        tempCanvas.width = canvas.width;
                        tempCanvas.height = canvas.height;
                        
                        // Copia il contenuto originale
                        tempCtx.drawImage(canvas, 0, 0);
                        
                        // Aggiungi il testo in basso a destra
                        const select = document.getElementById(`select-${phase.key}`);
                        const exercise = select ? getExerciseById(select.value) : null;
                        
                        if (exercise) {
                            tempCtx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                            tempCtx.fillRect(canvas.width - 200, canvas.height - 40, 200, 40);
                            
                            tempCtx.fillStyle = 'white';
                            tempCtx.font = 'bold 12px Arial';
                            tempCtx.textAlign = 'right';
                            tempCtx.fillText(`${phase.name}`, canvas.width - 10, canvas.height - 25);
                            
                            tempCtx.font = '10px Arial';
                            tempCtx.fillText(`${exercise.name}`, canvas.width - 10, canvas.height - 10);
                        }
                        
                        const dataURL = tempCanvas.toDataURL('image/png');
                        const base64Data = dataURL.split(',')[1];
                        const filename = `Schema_${index + 1}_${phase.name.replace(/[^a-zA-Z0-9]/g, '_')}.png`;
                        zip.file(filename, base64Data, {base64: true});
                    }
                }
            });
            
            if (count > 0) {
                zip.generateAsync({type: 'blob'}).then(function(content) {
                    const url = URL.createObjectURL(content);
                    const a = document.createElement('a');
                    a.href = url;
                    const dateStr = meta.data || new Date().toISOString().split('T')[0];
                    a.download = `Schemi_Tattici_${dateStr}_${meta.categoria}.zip`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                });
            }
        }
        
        function generateTacticalImagesWithPDF(meta, pdfBlob, pdfFilename) {
            const hasDrawings = Object.keys(tacticalDrawings).length > 0;
            
            // Crea un ZIP con tutti gli schemi e il PDF
            const zip = new JSZip();
            let count = 0;
            
            // Aggiungi gli schemi tattici se presenti
            if (hasDrawings) {
                PHASES.forEach((phase, index) => {
                    if (tacticalDrawings[phase.key]) {
                        count++;
                        const canvas = document.getElementById(`canvas-${phase.key}`);
                        if (canvas) {
                            // Crea una copia del canvas per aggiungere il testo
                            const tempCanvas = document.createElement('canvas');
                            const tempCtx = tempCanvas.getContext('2d');
                            tempCanvas.width = canvas.width;
                            tempCanvas.height = canvas.height;
                            
                            // Copia il contenuto originale
                            tempCtx.drawImage(canvas, 0, 0);
                            
                            // Aggiungi il testo in basso a destra
                            const select = document.getElementById(`select-${phase.key}`);
                            const exercise = select ? getExerciseById(select.value) : null;
                            
                            if (exercise) {
                                tempCtx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                                tempCtx.fillRect(canvas.width - 200, canvas.height - 40, 200, 40);
                                
                                tempCtx.fillStyle = 'white';
                                tempCtx.font = 'bold 12px Arial';
                                tempCtx.textAlign = 'right';
                                tempCtx.fillText(`${phase.name}`, canvas.width - 10, canvas.height - 25);
                                
                                tempCtx.font = '10px Arial';
                                tempCtx.fillText(`${exercise.name}`, canvas.width - 10, canvas.height - 10);
                            }
                            
                            const dataURL = tempCanvas.toDataURL('image/png');
                            const base64Data = dataURL.split(',')[1];
                            const filename = `Schema_${index + 1}_${phase.name.replace(/[^a-zA-Z0-9]/g, '_')}.png`;
                            zip.file(filename, base64Data, {base64: true});
                        }
                    }
                });
            }
            
            // Aggiungi sempre il PDF allo ZIP
            zip.file(pdfFilename, pdfBlob);
            
            // Genera e scarica lo ZIP
            zip.generateAsync({type: 'blob'}).then(function(content) {
                const url = URL.createObjectURL(content);
                const a = document.createElement('a');
                a.href = url;
                const dateStr = meta.data || new Date().toISOString().split('T')[0];
                const zipFilename = hasDrawings ? 
                    `Allenamento_Completo_${dateStr}_${meta.categoria}.zip` : 
                    `Piano_Allenamento_${dateStr}_${meta.categoria}.zip`;
                a.download = zipFilename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });
        }
        

        function buildSimplePDFWithDesign(lines) {
            const streamLength = calculateStreamLength(lines);
            
            const pdfContent = [
                '%PDF-1.4',
                '1 0 obj',
                '<<',
                '/Type /Catalog',
                '/Pages 2 0 R',
                '>>',
                'endobj',
                '',
                '2 0 obj',
                '<<',
                '/Type /Pages',
                '/Kids [3 0 R]',
                '/Count 1',
                '>>',
                'endobj',
                '',
                '3 0 obj',
                '<<',
                '/Type /Page',
                '/Parent 2 0 R',
                '/MediaBox [0 0 595.28 841.89]',
                '/Resources <<',
                '  /Font <<',
                '    /F1 4 0 R',
                '    /F2 5 0 R',
                '  >>',
                '>>',
                '/Contents 6 0 R',
                '>>',
                'endobj',
                '',
                '4 0 obj',
                '<<',
                '/Type /Font',
                '/Subtype /Type1',
                '/BaseFont /Helvetica',
                '>>',
                'endobj',
                '',
                '5 0 obj',
                '<<',
                '/Type /Font',
                '/Subtype /Type1',
                '/BaseFont /Helvetica-Bold',
                '>>',
                'endobj',
                '',
                '6 0 obj',
                '<<',
                '/Length ' + streamLength.toString(),
                '>>',
                'stream'
            ];
            
            // Content stream con design migliorato
            pdfContent.push('BT');
            pdfContent.push('/F2 24 Tf');
            pdfContent.push('0.1 0.6 0.4 rg'); // Verde Mister 2.0
            pdfContent.push('50 800 Td');
            pdfContent.push(`(${escapeString('Mister 2.0 ‚Äî Scheda Allenamento')}) Tj`);
            pdfContent.push('0 -30 Td');
            pdfContent.push('/F1 12 Tf');
            pdfContent.push('0.2 0.2 0.2 rg'); // Grigio scuro
            
            lines.forEach((line, i) => {
                if (i === 0) {
                    // Titolo gi√† aggiunto sopra
                    return;
                } else if (i === 1) {
                    // Riga vuota
                    pdfContent.push('0 -10 Td');
                } else if (i === 2 || i === 3) {
                    // Dati allenamento
                    pdfContent.push(`(${escapeString(line)}) Tj`);
                    pdfContent.push('0 -16 Td');
                } else if (line.includes('FASI & ESERCIZI')) {
                    // Titolo sezione
                    pdfContent.push('0 -10 Td');
                    pdfContent.push('/F2 16 Tf');
                    pdfContent.push('0.1 0.6 0.4 rg');
                    pdfContent.push(`(${escapeString(line)}) Tj`);
                    pdfContent.push('0 -20 Td');
                    pdfContent.push('/F1 12 Tf');
                    pdfContent.push('0.2 0.2 0.2 rg');
                } else if (line.includes('MATERIALE TOTALE')) {
                    // Materiale totale
                    pdfContent.push('0 -10 Td');
                    pdfContent.push('/F2 14 Tf');
                    pdfContent.push('0.1 0.6 0.4 rg');
                    pdfContent.push(`(${escapeString(line)}) Tj`);
                    pdfContent.push('0 -16 Td');
                    pdfContent.push('/F1 12 Tf');
                    pdfContent.push('0.2 0.2 0.2 rg');
                } else if (line.includes('Generato con')) {
                    // Crediti
                    pdfContent.push('0 -15 Td');
                    pdfContent.push('/F1 9 Tf');
                    pdfContent.push('0.5 0.5 0.5 rg');
                    pdfContent.push(`(${escapeString(line)}) Tj`);
                } else if (line.match(/^\d+\./)) {
                    // Nome fase
                    pdfContent.push('/F2 12 Tf');
                    pdfContent.push('0.1 0.6 0.4 rg');
                    pdfContent.push(`(${escapeString(line)}) Tj`);
                    pdfContent.push('0 -14 Td');
                    pdfContent.push('/F1 12 Tf');
                    pdfContent.push('0.2 0.2 0.2 rg');
                } else if (line.includes('Esercizio:')) {
                    // Esercizio
                    pdfContent.push('10 0 Td');
                    pdfContent.push('/F1 10 Tf');
                    pdfContent.push('0.2 0.2 0.2 rg');
                    pdfContent.push(`(${escapeString(line)}) Tj`);
                    pdfContent.push('-10 0 Td');
                    pdfContent.push('0 -12 Td');
                } else if (line.includes('Descrizione:')) {
                    // Descrizione
                    pdfContent.push('10 0 Td');
                    pdfContent.push('/F1 9 Tf');
                    pdfContent.push('0.3 0.3 0.3 rg');
                    pdfContent.push(`(${escapeString(line)}) Tj`);
                    pdfContent.push('-10 0 Td');
                    pdfContent.push('0 -11 Td');
                } else if (line.includes('Materiale:')) {
                    // Materiale
                    pdfContent.push('10 0 Td');
                    pdfContent.push('/F1 9 Tf');
                    pdfContent.push('0.4 0.2 0.2 rg');
                    pdfContent.push(`(${escapeString(line)}) Tj`);
                    pdfContent.push('-10 0 Td');
                    pdfContent.push('0 -11 Td');
                } else if (line.includes('Schema tattico:')) {
                    // Schema tattico
                    pdfContent.push('10 0 Td');
                    pdfContent.push('/F1 9 Tf');
                    pdfContent.push('0.1 0.6 0.4 rg');
                    pdfContent.push(`(${escapeString(line)}) Tj`);
                    pdfContent.push('-10 0 Td');
                    pdfContent.push('0 -11 Td');
                } else if (line.trim() === '') {
                    // Riga vuota
                    pdfContent.push('0 -8 Td');
                } else {
                    // Testo normale
                    pdfContent.push(`(${escapeString(line)}) Tj`);
                    pdfContent.push('0 -12 Td');
                }
            });
            
            pdfContent.push('ET');
            pdfContent.push('endstream');
            pdfContent.push('endobj');
            
            // Xref table
            const xrefPos = pdfContent.join('\n').length + 1;
            pdfContent.push('');
            pdfContent.push('xref');
            pdfContent.push('0 7');
            pdfContent.push('0000000000 65535 f ');
            pdfContent.push('0000000009 00000 n ');
            pdfContent.push('0000000074 00000 n ');
            pdfContent.push('0000000120 00000 n ');
            pdfContent.push('0000000274 00000 n ');
            pdfContent.push('0000000354 00000 n ');
            pdfContent.push('0000000434 00000 n ');
            
            // Trailer
            pdfContent.push('trailer');
            pdfContent.push('<<');
            pdfContent.push('/Size 7');
            pdfContent.push('/Root 1 0 R');
            pdfContent.push('>>');
            pdfContent.push('startxref');
            pdfContent.push(xrefPos.toString());
            pdfContent.push('%%EOF');
            
            return pdfContent.join('\n');
        }

        function calculateStreamLength(lines) {
            let length = 0;
            length += 'BT\n'.length;
            length += '/F2 24 Tf\n'.length;
            length += '0.1 0.6 0.4 rg\n'.length;
            length += '50 800 Td\n'.length;
            length += `(${escapeString('Mister 2.0 ‚Äî Scheda Allenamento')}) Tj\n`.length;
            length += '0 -30 Td\n'.length;
            length += '/F1 12 Tf\n'.length;
            length += '0.2 0.2 0.2 rg\n'.length;
            
            lines.forEach((line, i) => {
                if (i === 0) return;
                
                if (i === 1) {
                    length += '0 -10 Td\n'.length;
                } else if (i === 2 || i === 3) {
                    length += `(${escapeString(line)}) Tj\n`.length;
                    length += '0 -16 Td\n'.length;
                } else if (line.includes('FASI & ESERCIZI')) {
                    length += '0 -10 Td\n'.length;
                    length += '/F2 16 Tf\n'.length;
                    length += '0.1 0.6 0.4 rg\n'.length;
                    length += `(${escapeString(line)}) Tj\n`.length;
                    length += '0 -20 Td\n'.length;
                    length += '/F1 12 Tf\n'.length;
                    length += '0.2 0.2 0.2 rg\n'.length;
                } else if (line.includes('MATERIALE TOTALE')) {
                    length += '0 -10 Td\n'.length;
                    length += '/F2 14 Tf\n'.length;
                    length += '0.1 0.6 0.4 rg\n'.length;
                    length += `(${escapeString(line)}) Tj\n`.length;
                    length += '0 -16 Td\n'.length;
                    length += '/F1 12 Tf\n'.length;
                    length += '0.2 0.2 0.2 rg\n'.length;
                } else if (line.includes('Generato con')) {
                    length += '0 -15 Td\n'.length;
                    length += '/F1 9 Tf\n'.length;
                    length += '0.5 0.5 0.5 rg\n'.length;
                    length += `(${escapeString(line)}) Tj\n`.length;
                } else if (line.match(/^\d+\./)) {
                    length += '/F2 12 Tf\n'.length;
                    length += '0.1 0.6 0.4 rg\n'.length;
                    length += `(${escapeString(line)}) Tj\n`.length;
                    length += '0 -14 Td\n'.length;
                    length += '/F1 12 Tf\n'.length;
                    length += '0.2 0.2 0.2 rg\n'.length;
                } else if (line.includes('Esercizio:')) {
                    length += '10 0 Td\n'.length;
                    length += '/F1 10 Tf\n'.length;
                    length += '0.2 0.2 0.2 rg\n'.length;
                    length += `(${escapeString(line)}) Tj\n`.length;
                    length += '-10 0 Td\n'.length;
                    length += '0 -12 Td\n'.length;
                } else if (line.includes('Descrizione:')) {
                    length += '10 0 Td\n'.length;
                    length += '/F1 9 Tf\n'.length;
                    length += '0.3 0.3 0.3 rg\n'.length;
                    length += `(${escapeString(line)}) Tj\n`.length;
                    length += '-10 0 Td\n'.length;
                    length += '0 -11 Td\n'.length;
                } else if (line.includes('Materiale:')) {
                    length += '10 0 Td\n'.length;
                    length += '/F1 9 Tf\n'.length;
                    length += '0.4 0.2 0.2 rg\n'.length;
                    length += `(${escapeString(line)}) Tj\n`.length;
                    length += '-10 0 Td\n'.length;
                    length += '0 -11 Td\n'.length;
                } else if (line.includes('Schema tattico:')) {
                    length += '10 0 Td\n'.length;
                    length += '/F1 9 Tf\n'.length;
                    length += '0.1 0.6 0.4 rg\n'.length;
                    length += `(${escapeString(line)}) Tj\n`.length;
                    length += '-10 0 Td\n'.length;
                    length += '0 -11 Td\n'.length;
                } else if (line.trim() === '') {
                    length += '0 -8 Td\n'.length;
                } else {
                    length += `(${escapeString(line)}) Tj\n`.length;
                    length += '0 -12 Td\n'.length;
                }
            });
            
            length += 'ET\n'.length;
            return length;
        }

        function escapeString(str) {
            return str.replace(/\\/g, '\\\\')
                     .replace(/\(/g, '\\(')
                     .replace(/\)/g, '\\)')
                     .replace(/\r/g, '\\r')
                     .replace(/\n/g, '\\n');
        }

        async function shareWhatsApp() {
            // Genera prima il PDF
            await exportPDF();
            
            if (!lastPdfBlob) {
                alert('Errore nella generazione del PDF.');
                return;
            }
            
            const meta = {
                presenti: getPlayers(),
                data: document.getElementById('data').value,
                categoria: document.getElementById('categoria').value
            };
            
            // Crea un messaggio pi√π dettagliato
            let message = `üèÉ‚Äç‚ôÇÔ∏è *Scheda Allenamento ${meta.categoria}*\n`;
            message += `üìÖ Data: ${meta.data || 'da definire'}\n`;
            message += `üë• Presenti: ${meta.presenti}\n`;
            message += `‚öΩ Creato con Mister 2.0 by 2M Digital Consulting\n\n`;
            
            // Aggiungi informazioni sugli schemi tattici se presenti
            const hasTacticalDrawings = Object.keys(tacticalDrawings).length > 0;
            if (hasTacticalDrawings) {
                message += `üìã *Schemi Tattici Inclusi:*\n`;
                PHASES.forEach((phase, index) => {
                    if (tacticalDrawings[phase.key]) {
                        const select = document.getElementById(`select-${phase.key}`);
                        const exercise = select ? getExerciseById(select.value) : null;
                        if (exercise) {
                            message += `‚Ä¢ ${index + 1}. ${phase.name}: ${exercise.name}\n`;
                        }
                    }
                });
                message += `\nüìé *File allegato:*\n`;
                message += `‚Ä¢ ZIP completo con piano allenamento (PDF) e schemi tattici in alta risoluzione\n`;
            } else {
                message += `üìé *File allegato:* PDF con piano allenamento completo\n`;
            }
            
            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/?text=${encodedMessage}`;
            
            window.open(whatsappUrl, '_blank');
        }

        // ===== TACTICAL EDITOR FUNCTIONS =====
        
        function toggleTacticalEditor(phaseKey) {
            const editor = document.getElementById(`tactical-editor-${phaseKey}`);
            if (editor.classList.contains('active')) {
                editor.classList.remove('active');
            } else {
                editor.classList.add('active');
                initializeTacticalCanvas(phaseKey);
            }
        }
        
        function initializeTacticalCanvas(phaseKey) {
            const canvas = document.getElementById(`canvas-${phaseKey}`);
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // Imposta dimensioni responsive del canvas
            const container = canvas.parentElement;
            const containerWidth = container.clientWidth;
            
            // Mantieni proporzioni 10:7 (campo da calcio)
            const canvasWidth = Math.min(400, containerWidth - 20); // 20px per padding/border
            const canvasHeight = Math.round(canvasWidth * 0.7);
            
            // Imposta dimensioni effettive del canvas
            canvas.width = canvasWidth;
            canvas.height = canvasHeight;
            
            // Inizializza stato se non esiste
            if (!tacticalStates[phaseKey]) {
                tacticalStates[phaseKey] = {
                    tool: 'brush',
                    color: '#ff0000',
                    brushSize: 4,
                    isDrawing: false,
                    lastX: 0,
                    lastY: 0
                };
            }
            
            // Disegna campo base
            drawFootballField(ctx, canvas.width, canvas.height);
            
            // Carica disegno salvato se esiste
            if (tacticalDrawings[phaseKey]) {
                const img = new Image();
                img.onload = function() {
                    // Ridimensiona l'immagine salvata se necessario
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                };
                img.src = tacticalDrawings[phaseKey];
            }
            
            // Event listeners per disegno
            setupCanvasEventListeners(canvas, phaseKey);
            
            // Event listener per ridimensionamento finestra
            if (!window.tacticalResizeListenerAdded) {
                window.addEventListener('resize', function() {
                    // Ridimensiona tutti i canvas attivi dopo un breve delay
                    setTimeout(() => {
                        document.querySelectorAll('.tactical-editor.active canvas').forEach(activeCanvas => {
                            const phaseKey = activeCanvas.id.replace('canvas-', '');
                            initializeTacticalCanvas(phaseKey);
                        });
                    }, 100);
                });
                window.tacticalResizeListenerAdded = true;
            }
        }
        
        function drawFootballField(ctx, width, height) {
            // Sfondo verde
            ctx.fillStyle = '#2d5a2d';
            ctx.fillRect(0, 0, width, height);
            
            // Linee del campo
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 2;
            
            // Perimetro campo
            ctx.strokeRect(10, 10, width - 20, height - 20);
            
            // Linea di centrocampo
            ctx.beginPath();
            ctx.moveTo(width / 2, 10);
            ctx.lineTo(width / 2, height - 10);
            ctx.stroke();
            
            // Cerchio di centrocampo
            ctx.beginPath();
            ctx.arc(width / 2, height / 2, 30, 0, 2 * Math.PI);
            ctx.stroke();
            
            // Punto di centrocampo
            ctx.beginPath();
            ctx.arc(width / 2, height / 2, 2, 0, 2 * Math.PI);
            ctx.fill();
            
            // Aree di rigore
            const goalAreaWidth = 40;
            const goalAreaHeight = 20;
            
            // Area di rigore sinistra
            ctx.strokeRect(10, height / 2 - goalAreaHeight / 2, goalAreaWidth, goalAreaHeight);
            // Area di rigore destra
            ctx.strokeRect(width - 10 - goalAreaWidth, height / 2 - goalAreaHeight / 2, goalAreaWidth, goalAreaHeight);
            
            // Porte
            ctx.strokeRect(5, height / 2 - 15, 10, 30);
            ctx.strokeRect(width - 15, height / 2 - 15, 10, 30);
            
            // Punti del calcio di rigore
            ctx.beginPath();
            ctx.arc(10 + goalAreaWidth, height / 2, 2, 0, 2 * Math.PI);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(width - 10 - goalAreaWidth, height / 2, 2, 0, 2 * Math.PI);
            ctx.fill();
        }
        
        function setupCanvasEventListeners(canvas, phaseKey) {
            const state = tacticalStates[phaseKey];
            
            // Mouse events
            canvas.addEventListener('mousedown', (e) => startDrawing(e, phaseKey));
            canvas.addEventListener('mousemove', (e) => draw(e, phaseKey));
            canvas.addEventListener('mouseup', () => stopDrawing(phaseKey));
            canvas.addEventListener('mouseout', () => stopDrawing(phaseKey));
            
            // Touch events per dispositivi mobili
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent('mousedown', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                canvas.dispatchEvent(mouseEvent);
            });
            
            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent('mousemove', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                canvas.dispatchEvent(mouseEvent);
            });
            
            canvas.addEventListener('touchend', (e) => {
                e.preventDefault();
                const mouseEvent = new MouseEvent('mouseup', {});
                canvas.dispatchEvent(mouseEvent);
            });
        }
        
        function getMousePos(canvas, e) {
            const rect = canvas.getBoundingClientRect();
            return {
                x: e.clientX - rect.left,
                y: e.clientY - rect.top
            };
        }
        
        function startDrawing(e, phaseKey) {
            const canvas = document.getElementById(`canvas-${phaseKey}`);
            const pos = getMousePos(canvas, e);
            const state = tacticalStates[phaseKey];
            
            state.isDrawing = true;
            state.lastX = pos.x;
            state.lastY = pos.y;
            
            updateTacticalStatus(phaseKey, 'Disegnando...');
        }
        
        function draw(e, phaseKey) {
            const canvas = document.getElementById(`canvas-${phaseKey}`);
            const ctx = canvas.getContext('2d');
            const state = tacticalStates[phaseKey];
            
            if (!state.isDrawing) return;
            
            const pos = getMousePos(canvas, e);
            
            ctx.beginPath();
            ctx.moveTo(state.lastX, state.lastY);
            ctx.lineTo(pos.x, pos.y);
            
            if (state.tool === 'brush') {
                ctx.strokeStyle = state.color;
                ctx.lineWidth = state.brushSize;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
            } else if (state.tool === 'eraser') {
                ctx.globalCompositeOperation = 'destination-out';
                ctx.lineWidth = state.brushSize * 2;
            }
            
            ctx.stroke();
            ctx.globalCompositeOperation = 'source-over';
            
            state.lastX = pos.x;
            state.lastY = pos.y;
        }
        
        function stopDrawing(phaseKey) {
            const state = tacticalStates[phaseKey];
            state.isDrawing = false;
            
            // Salvataggio automatico
            const canvas = document.getElementById(`canvas-${phaseKey}`);
            if (canvas) {
                tacticalDrawings[phaseKey] = canvas.toDataURL();
            }
            
            updateTacticalStatus(phaseKey, 'Pronto per disegnare');
        }
        
        function setTool(phaseKey, tool) {
            const state = tacticalStates[phaseKey];
            state.tool = tool;
            
            // Aggiorna UI
            const buttons = document.querySelectorAll(`#tactical-editor-${phaseKey} .tool-btn`);
            buttons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.tool === tool) {
                    btn.classList.add('active');
                }
            });
            
            // Aggiorna cursore
            const canvas = document.getElementById(`canvas-${phaseKey}`);
            if (tool === 'brush') {
                canvas.style.cursor = 'crosshair';
            } else if (tool === 'eraser') {
                canvas.style.cursor = 'grab';
            }
            
            updateTacticalStatus(phaseKey, `Strumento: ${tool === 'brush' ? 'Pennello' : 'Gomma'}`);
        }
        
        function setColor(phaseKey, color) {
            const state = tacticalStates[phaseKey];
            state.color = color;
            
            // Aggiorna UI
            const colorBtns = document.querySelectorAll(`#tactical-editor-${phaseKey} .color-btn`);
            colorBtns.forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.color === color) {
                    btn.classList.add('active');
                }
            });
            
            updateTacticalStatus(phaseKey, `Colore: ${color}`);
        }
        
        function setBrushSize(phaseKey, size) {
            const state = tacticalStates[phaseKey];
            state.brushSize = parseInt(size);
            
            // Aggiorna UI
            document.getElementById(`brush-size-value-${phaseKey}`).textContent = size + 'px';
            
            updateTacticalStatus(phaseKey, `Spessore: ${size}px`);
        }
        
        function redrawField(phaseKey) {
            const canvas = document.getElementById(`canvas-${phaseKey}`);
            const ctx = canvas.getContext('2d');
            
            // Salva disegno attuale
            const currentDrawing = canvas.toDataURL();
            
            // Ridisegna campo
            drawFootballField(ctx, canvas.width, canvas.height);
            
            // Ripristina disegno
            if (currentDrawing !== canvas.toDataURL()) {
                const img = new Image();
                img.onload = function() {
                    ctx.drawImage(img, 0, 0);
                };
                img.src = currentDrawing;
            }
            
            updateTacticalStatus(phaseKey, 'Campo ridisegnato');
        }
        
        function clearTacticalCanvas(phaseKey) {
            const canvas = document.getElementById(`canvas-${phaseKey}`);
            const ctx = canvas.getContext('2d');
            
            // Ridisegna solo il campo base
            drawFootballField(ctx, canvas.width, canvas.height);
            
            // Rimuovi disegno salvato
            delete tacticalDrawings[phaseKey];
            
            updateTacticalStatus(phaseKey, 'Campo pulito');
        }
        
        function saveTacticalDrawing(phaseKey) {
            const canvas = document.getElementById(`canvas-${phaseKey}`);
            tacticalDrawings[phaseKey] = canvas.toDataURL();
            
            updateTacticalStatus(phaseKey, 'Schema salvato automaticamente');
        }
        
        function updateTacticalStatus(phaseKey, message) {
            const statusEl = document.getElementById(`tactical-status-${phaseKey}`);
            if (statusEl) {
                statusEl.textContent = message;
            }
        }
        

        function init() {
            // Set today's date and year
            const today = new Date();
            document.getElementById('data').value = today.toISOString().split('T')[0];
            document.getElementById('year').textContent = today.getFullYear();
            
            // Aggiungi event listener per cambio numero presenti
            document.getElementById('presenti').addEventListener('input', function() {
                renderPhases();
                updateTotalMaterials();
                updateValidityStatus();
            });
            
            // Renderizza le fasi iniziali
            renderPhases();
            updateTotalMaterials();
            updateValidityStatus();
        }

        // Inizializzazione quando il DOM √® pronto
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
