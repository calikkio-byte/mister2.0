<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mister 2.0 – Planner Allenamenti</title>
<style>
:root{
  --bg:#f6f7f4; --card:#ffffff; --muted:#6b7280; --text:#111827;
  --green:#0aa85e; --green-700:#0a8f52; --border:#e5e7eb;
  --chip:#eef7f1; --radius:14px; --shadow:0 1px 2px rgba(0,0,0,.05), 0 8px 24px rgba(0,0,0,.06)
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial}
h1{font-size:1.35rem;margin:.2rem 0 .6rem}
h2{font-size:1.05rem;color:#0f172a;margin:.2rem 0 .6rem}
.smallmuted,.sub{color:var(--muted)}
.container{max-width:1100px;margin:0 auto;padding:12px}
.header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
.brand{display:flex;flex-direction:column}
.badge{display:inline-flex;align-items:center;gap:6px;background:var(--chip);color:var(--green-700);padding:4px 8px;border-radius:999px;font-weight:600;font-size:.75rem}
.app{display:grid;grid-template-columns:1fr;gap:12px}
@media(min-width:980px){.app{grid-template-columns:2fr 1fr}}
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
.card .hd{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:8px}
.card .bd{padding:12px 14px}
.grid{display:grid;gap:10px}
.grid.cols-3{grid-template-columns:repeat(3,1fr)}
@media(max-width:720px){.grid.cols-3{grid-template-columns:1fr}}
label{display:block;font-size:.83rem;color:#374151;margin-bottom:4px}
input[type="text"],input[type="number"],input[type="date"],input[type="time"],select,textarea{
  width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff;
  outline:none;transition:border-color .15s,box-shadow .15s
}
textarea{min-height:70px;resize:vertical}
input:focus-visible,select:focus-visible,textarea:focus-visible{border-color:var(--green);box-shadow:0 0 0 3px rgba(10,168,94,.15)}
.row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
.btn{appearance:none;border:1px solid transparent;background:var(--green);color:#fff;font-weight:700;padding:10px 12px;border-radius:999px;cursor:pointer}
.btn:hover{background:var(--green-700)}
.btn.secondary{background:#fff;border-color:var(--border);color:#111827}
.btn.ghost{background:transparent;border-color:var(--border);color:#111827}
.btn.small{padding:8px 10px;font-size:.9rem}
.note{font-size:.9rem;color:#374151;background:#f9fafb;border:1px dashed var(--border);border-radius:10px;padding:10px 12px}
.material{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
.chip{font-size:.8rem;background:var(--chip);border:1px solid #d7eedf;color:#065f3d;padding:6px 8px;border-radius:999px;white-space:nowrap}
.chip.ghost{background:#fff;border-color:var(--border);color:#374151}
.sidebar .bd{display:flex;flex-direction:column;gap:10px}
.footer{padding:22px 12px;color:var(--muted);font-size:.85rem;text-align:center}
hr.soft{border:0;height:1px;background:var(--border);margin:12px 0}
table.meta{width:100%;border-collapse:collapse;font-size:.9rem}
table.meta td{padding:6px 4px;vertical-align:top}
table.meta td:first-child{color:#374151;width:120px}
.empty-total{color:var(--muted);font-style:italic}
</style>
</head>
<body>
  <div class="container">
    <header class="header">
      <div class="brand">
        <h1>Mister 2.0 – Planner Allenamenti</h1>
        <span class="sub">by <strong>2M Digital Consulting srls</strong></span>
      </div>
      <span class="badge">⚽ Mister 2.0</span>
    </header>
<section class="card">
  <div class="hd">
    <strong>Dati di intestazione</strong>
    <span class="smallmuted">Compila per generare la scheda</span>
  </div>
  <div class="bd">
    <div class="grid cols-3">
      <div>
        <label for="presenti">Numero presenti (4–20) *</label>
        <input id="presenti" type="number" min="4" max="20" placeholder="Es. 12" required />
      </div>
      <div>
        <label for="data">Data</label>
        <input id="data" type="date" />
      </div>
      <div>
        <label for="ora">Ora</label>
        <input id="ora" type="time" />
      </div>
      <div>
        <label for="campo">Campo</label>
        <input id="campo" type="text" placeholder="Es. Campo A – metà destra" />
      </div>
      <div>
        <label for="mister">Mister</label>
        <input id="mister" type="text" placeholder="Es. Marco Calicchio" />
      </div>
      <div>
        <label for="categoria">Categoria</label>
        <select id="categoria">
          <option>Primi Calci</option>
          <option>Pulcini</option>
          <option selected>Esordienti</option>
          <option>Giovanissimi</option>
          <option>Allievi</option>
          <option>Juniores</option>
        </select>
      </div>
      <div style="grid-column:1/-1">
        <label for="note">Note</label>
        <textarea id="note" placeholder="Indicazioni extra, obiettivi specifici, vincoli di spazio..."></textarea>
      </div>
    </div>
  </div>
</section>

<div class="app">
  <main class="card" id="phasesCard">
    <div class="hd">
      <strong>Fasi della seduta (90ʼ)</strong>
      <div class="row">
        <button class="btn small" id="btnSuggest">Suggerisci set completo</button>
        <button class="btn small secondary" id="btnClear">Svuota</button>
        <button class="btn small ghost" id="btnSave">Salva nel browser</button>
        <button class="btn small ghost" id="btnLoad">Carica ultimo</button>
      </div>
    </div>
    <div class="bd" id="phases"></div>
  </main>

  <aside class="card sidebar">
    <div class="hd">
      <strong>Materiale totale</strong>
      <div class="row">
        <button class="btn small" id="btnPdf" title="Esporta PDF 1 pagina A4">Esporta PDF</button>
        <button class="btn small secondary" id="btnShareWA" title="Invia via WhatsApp il PDF">Invia WhatsApp</button>
      </div>
    </div>
    <div class="bd">
      <div id="totaleChips" class="material"></div>
      <div id="totaleEmpty" class="empty-total">Seleziona gli esercizi per vedere il materiale totale. <br/>Nota: <strong>palloni</strong> = massimo tra le fasi.</div>
      <hr class="soft"/>
      <div class="note">
        <strong>Filtro esercizi</strong><br/>Se le opzioni sono &lt; 2, si allarga temporaneamente a ±1 giocatore finché non ci sono almeno due alternative.
      </div>
    </div>
  </aside>
</div>

<footer class="footer" id="footer"></footer>
  </div>
<script>
/* ======== DATASET ORIGINALE ======== */
const DB = {
  ATTIVAZIONE: [
    {id:'att1', name:'Corsa + cambi direzione al fischio', min:4, max:20, desc:'Corsa libera in spazio delimitato; al fischio cambio direzione o gesto tecnico.', mats:{fischietto:1, cinesini:8}},
    {id:'att2', name:'Staffetta con conduzione palla', min:4, max:20, desc:'File per squadra: guida palla, gira il cono, rientra e dai il cinque.', mats:{palloni:'per_giocatore', conetti:12}},
    {id:'att3', name:'Rubapalla (tutti con una palla)', min:4, max:20, desc:'Proteggi la tua palla e prova a rubare quella degli altri.', mats:{palloni:'per_giocatore', cinesini:8}},
    {id:'att4', name:'Quadrato coordinativo (skip/balzi/sprint)', min:4, max:20, desc:'Giri del quadrato con compiti motori diversi ad ogni lato.', mats:{cinesini:16}},
    {id:'att5', name:'Slalom conetti a tempo', min:4, max:20, desc:'Slalom tra coni e sprint finale (classifica a tempo).', mats:{conetti:12, palloni:'per_giocatore'}},
    {id:'att6', name:'Circuito scale + ostacoli', min:4, max:20, desc:'Rapidi piedi in scala, 2–3 balzi su ostacoli, sprint 10m.', mats:{scale:1, ostacoli:6, cinesini:8}},
    {id:'att7', name:'Conduzione con comandi colore', min:4, max:20, desc:'Cambio direzione/piede al colore chiamato.', mats:{palloni:'per_giocatore', cinesini:20, fischietto:1}},
    {id:'att8', name:'Coppie sincronizzate', min:4, max:20, desc:'A coppie: corsa mirroring con cambi ritmo.', mats:{cinesini:8}},
    {id:'att9', name:'Tiro di precisione “colpisci il cono”', min:4, max:20, desc:'Tiri mirati su conetti a distanza crescente.', mats:{palloni:3, conetti:12}},
    {id:'att10', name:'“Chi ha la palla?” (un pallone in meno)', min:5, max:20, desc:'Un pallone in meno dei giocatori: chi resta senza compito motorio.', mats:{palloni:'giocatori_meno_1', cinesini:6}}
  ],
  TECNICA: [
    {id:'tec1', name:'Passaggi a coppie con stop orientato', min:4, max:20, desc:'Controllo orientato e passaggio in corsa.', mats:{palloni:'per_coppia', cinesini:8}},
    {id:'tec2', name:'Triangoli di passaggio in movimento', min:4, max:20, desc:'Sequenze a 3 con rotazioni.', mats:{palloni:2, cinesini:12}},
    {id:'tec3', name:'1 vs 1 a porte piccole', min:4, max:20, desc:'Duelli rapidi, tante ripetizioni.', mats:{palloni:2, porticine:2, cinesini:8}},
    {id:'tec4', name:'Guida tra ostacoli + tiro', min:4, max:20, desc:'Slalom e conclusione su porticine.', mats:{palloni:'per_giocatore', conetti:12, porticine:2}},
    {id:'tec5', name:'Rondo 4 vs 1 (o 3 vs 1 per 4-5)', min:4, max:20, desc:'Possesso veloce con 1 difendente.', mats:{palloni:1, cinesini:8}},
    {id:'tec6', name:'Passaggi di prima in movimento', min:4, max:20, desc:'Timing e orientamento corpo.', mats:{palloni:2, cinesini:12}},
    {id:'tec7', name:'Ricezione su porte colorate', min:4, max:20, desc:'Scegli la porta giusta al colore.', mats:{palloni:2, porticine:4, cinesini:12}},
    {id:'tec8', name:'2 vs 1 in spazi ridotti', min:5, max:20, desc:'Superiorità e tempi di passaggio.', mats:{palloni:2, cinesini:8, porticine:2}},
    {id:'tec9', name:'Slalom + scarico + tiro', min:5, max:20, desc:'Progressione tecnica con finalizzazione.', mats:{palloni:3, conetti:12, porticine:1}},
    {id:'tec10', name:'Rondo 5 vs 2 (per 7+)', min:7, max:20, desc:'Velocità di circolazione palla.', mats:{palloni:1, cinesini:8}}
  ],
  SITUAZIONALE: [
    {id:'sit1', name:'3 vs 2 a salire', min:5, max:20, desc:'Attacco in superiorità; chi recupera riparte.', mats:{palloni:2, porticine:2, cinesini:8}},
    {id:'sit3', name:'2 vs 1 con conclusione', min:5, max:20, desc:'Scelta tra portare palla o passare.', mats:{palloni:2, porticine:2, cinesini:6}},
    {id:'sit9', name:'Rimessa laterale: 3 vs 2', min:5, max:20, desc:'Schemi rapidi da laterale.', mats:{palloni:2, porticine:2, cinesini:6}},
    {id:'sit6', name:'2 vs 2 + portieri', min:6, max:20, desc:'Rifinitura e conclusioni rapide.', mats:{palloni:2, porticine:2}},
    {id:'sit4', name:'3 vs 3 + 2 jolly esterni', min:7, max:20, desc:'Sfrutta ampiezza con jolly laterali.', mats:{palloni:2, porticine:2, cinesini:12}},
    {id:'sit10', name:'Uscita 3 vs 2 vs pressing', min:7, max:20, desc:'Costruzione pulita sotto pressione.', mats:{palloni:3, cinesini:16, porticine:2}},
    {id:'sit2', name:'4 vs 3 con transizione', min:7, max:20, desc:'Cambio fase immediato al recupero.', mats:{palloni:2, porticine:2, cinesini:10}},
    {id:'sit8', name:'Cross & finalizzazione (3 vs 2 area)', min:7, max:20, desc:'Traversoni e attacco palla.', mats:{palloni:3, porte:1, cinesini:12, paletti:6}},
    {id:'sit5', name:'5 vs 4 da metà campo', min:9, max:20, desc:'Sviluppo in zona offensiva, coperture.', mats:{palloni:2, porte:2, cinesini:12}},
    {id:'sit7', name:'Sovrapposizioni obbligatorie', min:8, max:20, desc:'Tempismo, ampiezza e cross.', mats:{palloni:2, cinesini:12, porticine:2}}
  ],
  GIOCO: [
    {id:'gio2', name:'3 vs 3 + jolly', min:7, max:20, desc:'Il jolly gioca con chi ha palla.', mats:{palloni:1, porticine:2, pettorine:'per_giocatore'}},
    {id:'gio11', name:'3 vs 3 “doppio tocco”', min:7, max:20, desc:'Max 2 tocchi per giocatore.', mats:{palloni:1, porticine:2, pettorine:'per_giocatore'}},
    {id:'gio1', name:'4 vs 4 (3 passaggi obbligatori)', min:8, max:20, desc:'Gol valido dopo 3 passaggi.', mats:{palloni:1, porticine:2, pettorine:'per_giocatore'}},
    {id:'gio3', name:'Campo in 3 zone (passare in tutte)', min:8, max:20, desc:'Costruzione paziente e ampiezza.', mats:{palloni:1, porticine:2, cinesini:12}},
    {id:'gio8', name:'Due porticine per lato', min:8, max:20, desc:'Ricerca spazi e angoli di tiro.', mats:{palloni:1, porticine:4}},
    {id:'gio6', name:'Gol lampo entro 6"', min:8, max:20, desc:'Transizioni e velocità decisionale.', mats:{palloni:1, porticine:2, cronometro:1}},
    {id:'gio5', name:'Punti doppi da cross', min:10, max:20, desc:'Valorizza fasce e traversoni.', mats:{palloni:2, porte:2, cinesini:12, paletti:4}},
    {id:'gio9', name:'Portiere volante', min:10, max:20, desc:'Il portiere partecipa al possesso.', mats:{palloni:1, porte:2, pettorine:'per_giocatore'}},
    {id:'gio10', name:'Re del campo', min:9, max:20, desc:'Chi segna resta, chi subisce esce.', mats:{palloni:2, porticine:2, pettorine:'per_giocatore'}},
    {id:'gio12', name:'4 vs 4 + 2 jolly laterali', min:10, max:20, desc:'Ampiezza e sponde esterne.', mats:{palloni:1, porticine:2, pettorine:'per_giocatore'}}
  ],
  PARTITA: [
    {id:'parA1', name:'Partita 2 vs 2 (porte piccole)', min:4, max:20, desc:'Duelli 2v2, cambi rapidi.', mats:{palloni:1, porticine:2, pettorine:'per_giocatore'}},
    {id:'parA2', name:'2 vs 2 a porticine multiple', min:4, max:20, desc:'Due porticine per lato → ricerca linee di tiro.', mats:{palloni:1, porticine:4, pettorine:'per_giocatore'}},
    {id:'parB1', name:'2 vs 2 + 1 jolly (per 5)', min:5, max:20, desc:'Superiorità palla al portatore.', mats:{palloni:1, porticine:2, pettorine:'per_giocatore'}},
    {id:'parB2', name:'3 vs 2 transizioni rapide', min:5, max:20, desc:'Chi recupera riparte subito.', mats:{palloni:1, porticine:2, pettorine:'per_giocatore'}},
    {id:'parC1', name:'3 vs 3 (campo ridotto)', min:6, max:20, desc:'Intensità alta, tanti tocchi.', mats:{palloni:1, porticine:2, pettorine:'per_giocatore'}},
    {id:'parC2', name:'2 vs 2 + portieri', min:6, max:20, desc:'Conclusioni frequenti.', mats:{palloni:1, porticine:2, pettorine:'per_giocatore'}},
    {id:'parD1', name:'3 vs 3 + jolly', min:7, max:20, desc:'Supporto costante al portatore.', mats:{palloni:1, porticine:2, pettorine:'per_giocatore'}},
    {id:'parD2', name:'4 vs 3 (superiorità)', min:7, max:20, desc:'Ricerca dell’uomo libero.', mats:{palloni:1, porticine:2, pettorine:'per_giocatore'}},
    {id:'parE1', name:'4 vs 4', min:8, max:20, desc:'Spazi medi, coperture e triangolazioni.', mats:{palloni:1, porticine:2, pettorine:'per_giocatore'}},
    {id:'parE2', name:'3 vs 3 con 2 porticine per lato', min:8, max:20, desc:'Scelta lato debole, finalizzazione.', mats:{palloni:1, porticine:4, pettorine:'per_giocatore'}},
    {id:'parF1', name:'4 vs 4 + jolly', min:9, max:20, desc:'Sponde per uscire dalla pressione.', mats:{palloni:1, porticine:2, pettorine:'per_giocatore'}},
    {id:'parF2', name:'Torneo 3x3x3 (tre squadre)', min:9, max:20, desc:'Rotazioni: chi segna resta.', mats:{palloni:2, porticine:2, pettorine:'per_giocatore'}},
    {id:'par1', name:'5 vs 5 (campo ridotto)', min:10, max:20, desc:'Applicazione su campo corto.', mats:{palloni:1, porticine:4, pettorine:'per_giocatore'}},
    {id:'par1b', name:'5 vs 5 con 4 porticine', min:10, max:20, desc:'Cambio fronte e rapidità di scelta.', mats:{palloni:1, porticine:4, pettorine:'per_giocatore'}},
    {id:'par2', name:'6 vs 6', min:12, max:20, desc:'Più linee di passaggio e coperture.', mats:{palloni:1, porte:2, pettorine:'per_giocatore'}},
    {id:'par7', name:'Limite 3 tocchi (6v6+)', min:12, max:20, desc:'Velocità decisionale.', mats:{palloni:1, porte:2}},
    {id:'par3', name:'7 vs 7', min:14, max:20, desc:'Allarga spazi e tempi di gioco.', mats:{palloni:1, porte:2, pettorine:'per_giocatore'}},
    {id:'par4', name:'8 vs 8', min:16, max:20, desc:'Quasi formato 9v9.', mats:{palloni:1, porte:2, pettorine:'per_giocatore'}},
    {id:'par5', name:'9 vs 9 (regole ufficiali)', min:18, max:20, desc:'Fuorigioco ultimo terzo, retropassaggio ecc.', mats:{palloni:1, porte:2, pettorine:'per_giocatore'}},
    {id:'par6', name:'Ruoli a rotazione ogni 5ʼ', min:12, max:20, desc:'Sperimentazione ruoli e responsabilità.', mats:{palloni:1, porte:2, cronometro:1, pettorine:'per_giocatore'}}
  ],
  DEFATICAMENTO: [
    {id:'def1', name:'Corsa lenta + stretching gambe', min:4, max:20, desc:'Rientro alla calma e allungamento.', mats:{}},
    {id:'def2', name:'Camminata a coppie (feedback)', min:4, max:20, desc:'Condivisione di ciò che è piaciuto/imparato.', mats:{}},
    {id:'def3', name:'Stretching a stazioni (player leader)', min:4, max:20, desc:'Un giocatore guida ogni stazione.', mats:{cinesini:8}},
    {id:'def5', name:'Gioco leggero: palla in aria', min:4, max:20, desc:'Cooperazione, la palla non deve cadere.', mats:{palloni:1}},
    {id:'def7', name:'Stretching dinamico controllato', min:4, max:20, desc:'Movimenti lenti e coordinati.', mats:{}},
    {id:'def9', name:'Mini debrief: “cosa ho imparato?”', min:4, max:20, desc:'1 idea a testa.', mats:{}},
    {id:'def10', name:'Saluto di squadra', min:4, max:20, desc:'Rituale finale positivo.', mats:{}},
    {id:'def11', name:'Respirazione + rilassamento', min:4, max:20, desc:'In piedi/seduti, focus sul respiro.', mats:{}},
    {id:'def12', name:'Camminata in cerchio + ritmo', min:4, max:20, desc:'Battimani e respirazione coordinata.', mats:{}},
    {id:'def13', name:'Gamba contro gamba (coppie)', min:4, max:20, desc:'Allungamenti in coppia.', mats:{}}
  ]
};

/* ======== FASI, DURATE E FINESTRE TEMPORALI ======== */
const PHASES = [
  { key:'ATTIVAZIONE', title:'Attivazione & Riscaldamento (0–10ʼ)', window:'0–10ʼ', duration:10 },
  { key:'TECNICA', title:'Tecnica di Base (10–25ʼ)', window:'10–25ʼ', duration:15 },
  { key:'SITUAZIONALE', title:'Esercizi Situazionali (25–45ʼ)', window:'25–45ʼ', duration:20 },
  { key:'GIOCO', title:'Giochi a Tema (45–65ʼ)', window:'45–65ʼ', duration:20 },
  { key:'PARTITA', title:'Partita/Applicazione (65–85ʼ)', window:'65–85ʼ', duration:20 },
  { key:'DEFATICAMENTO', title:'Defaticamento & Feedback (85–90ʼ)', window:'85–90ʼ', duration:5 }
];

const MAT_LABELS = {
  palloni:'Palloni', cinesini:'Cinesini', conetti:'Conetti', paletti:'Paletti', aste:'Aste',
  porticine:'Porticine', porte:'Porte', ostacoli:'Ostacoli', scale:'Scale',
  pettorine:'Pettorine', fischietto:'Fischietto', cronometro:'Cronometro',
  lavagnetta:'Lavagnetta', nastro:'Nastro'
};
const MAT_ORDER = ['palloni','cinesini','conetti','paletti','aste','porticine','porte','ostacoli','scale','pettorine','fischietto','cronometro','lavagnetta','nastro'];

/* ======== STATO ======== */
let selections = {}; // { PHASE_KEY: exerciseId }
let optionsCache = {};
let lastPdfBlob = null;
let lastPdfFilename = '';

/* ======== UTIL ======== */
function labelFor(k){ return MAT_LABELS[k] || k; }
function getPresenti(){
  const n = parseInt(document.getElementById('presenti').value,10);
  if(Number.isNaN(n)) return null;
  return Math.min(20, Math.max(4, n));
}
function getExerciseById(phaseKey, id){ return (DB[phaseKey]||[]).find(x=>x.id===id)||null; }
function resolveQty(v, presenti){
  if(typeof v==='number') return v;
  if(v==='per_giocatore') return presenti;
  if(v==='per_coppia') return Math.ceil(presenti/2);
  if(v==='giocatori_meno_1') return Math.max(presenti-1,1);
  return 0;
}
function prettyMaterialList(mats, presenti){
  const out=[];
  for(const k of MAT_ORDER){
    if(mats[k]===undefined) continue;
    const q=resolveQty(mats[k],presenti);
    if(q>0) out.push(`${labelFor(k)} ${q}`);
  }
  return out.join(', ');
}
function expandRange(base){
  const vals=[base];
  for(let d=1; d<=16; d++){
    const dn=base-d, up=base+d;
    if(dn>=4) vals.push(dn);
    if(up<=20) vals.push(up);
    if(vals.length>40) break;
  }
  return vals;
}
function optionsForPhase(phaseKey, presenti){
  const base=DB[phaseKey]||[];
  const chosen=new Set(); const result=[];
  const order=new Map(base.map((x,i)=>[x.id,i]));
  for(const p of expandRange(presenti)){
    for(const ex of base){
      if(ex.min<=p && p<=ex.max && !chosen.has(ex.id)){
        result.push(ex); chosen.add(ex.id);
      }
    }
    if(result.length>=2) break;
  }
  result.sort((a,b)=>order.get(a.id)-order.get(b.id));
  return result;
}
function aggregateMaterials(selectionsMap, presenti){
  const total={}; let maxBalls=0;
  for(const phase of PHASES){
    const id=selectionsMap[phase.key]; if(!id) continue;
    const ex=getExerciseById(phase.key,id); if(!ex) continue;
    for(const [k,v] of Object.entries(ex.mats||{})){
      const qty=resolveQty(v,presenti);
      if(k==='palloni'){ if(qty>maxBalls) maxBalls=qty; }
      else total[k]=(total[k]||0)+qty;
    }
  }
  if(maxBalls>0) total.palloni=maxBalls;
  return total;
}
function aggregateTotalsForPrint(total){
  const parts=[];
  if(total.palloni){ parts.push(`Palloni: ${total.palloni}`); }
  for(const k of MAT_ORDER){ if(k==='palloni') continue; const v=total[k]; if(v>0) parts.push(`${labelFor(k)}: ${v}`); }
  return parts.join('; ');
}
function collectMeta(){
  return {
    presenti:getPresenti(),
    data:document.getElementById('data').value||'',
    ora:document.getElementById('ora').value||'',
    campo:document.getElementById('campo').value||'',
    mister:document.getElementById('mister').value||'',
    categoria:document.getElementById('categoria').value||'Esordienti',
    note:document.getElementById('note').value||''
  };
}
function saveState(){
  localStorage.setItem('mister20_state', JSON.stringify({ meta:collectMeta(), selections }));
  alert('Stato salvato nel browser.');
}
function loadState(){
  const raw=localStorage.getItem('mister20_state'); if(!raw){ alert('Nessun salvataggio trovato.'); return; }
  try{
    const {meta,selections:sel}=JSON.parse(raw)||{};
    if(meta){
      if(meta.presenti){ document.getElementById('presenti').value=meta.presenti; }
      document.getElementById('data').value=meta.data||'';
      document.getElementById('ora').value=meta.ora||'';
      document.getElementById('campo').value=meta.campo||'';
      document.getElementById('mister').value=meta.mister||'';
      document.getElementById('categoria').value=meta.categoria||'Esordienti';
      document.getElementById('note').value=meta.note||'';
    }
    selections=sel||{};
    renderPhases();
    for(const p of PHASES){
      const id=selections[p.key]; const selEl=document.getElementById(`sel_${p.key}`);
      if(selEl && id && [...selEl.options].some(o=>o.value===id)){
        selEl.value=id; updatePhaseDetails(p.key,id);
      }
    }
    updateTotalsUI();
  }catch(e){ console.error(e); alert('Impossibile caricare il salvataggio.'); }
}
function wrapText(text,maxChars){
  const words=(text||'').split(/\s+/); const lines=[]; let line='';
  for(const w of words){
    if((line ? line+' ' : '') .length + w.length <= maxChars){ line += (line? ' ':'') + w; }
    else{ if(line) lines.push(line); if(w.length>maxChars){ for(let i=0;i<w.length;i+=maxChars) lines.push(w.slice(i,i+maxChars)); line=''; } else line=w; }
  }
  if(line) lines.push(line);
  return lines;
}
function asciiSafe(str){
  return (str||'')
    .replace(/[ʼ’‘]/g,"'").replace(/[“”]/g,'"').replace(/–|—/g,'-')
    .normalize('NFKD').replace(/[\u0300-\u036f]/g,'')
    .replace(/[\u2011\u00A0]/g,' ')
    .replace(/\\/g,'\\\\').replace(/$begin:math:text$/g,'\\\\(').replace(/$end:math:text$/g,'\\)');
}
function padRight(str,len){ str=asciiSafe(str||''); if(str.length>=len) return str.slice(0,len); return str + ' '.repeat(len-str.length); }

/* ======== RENDER ======== */
function renderPhases(){
  const presenti=getPresenti();
  const container=document.getElementById('phases');
  container.innerHTML='';
  const info=document.createElement('div');
  info.className='note';
  info.innerHTML= presenti
    ? `Numero presenti impostato a <strong>${presenti}</strong>. Gli esercizi sotto sono filtrati.`
    : `Imposta <strong>Numero presenti</strong> per abilitare la scelta degli esercizi.`;
  container.appendChild(info);

  optionsCache = {};
  for(const phase of PHASES){
    const wrap=document.createElement('div'); wrap.className='phase';
    const h=document.createElement('h2'); h.textContent=phase.title; wrap.appendChild(h);

    const selWrap=document.createElement('div'); selWrap.className='selwrap';

    const lab=document.createElement('label'); lab.htmlFor=`sel_${phase.key}`; lab.textContent='Seleziona esercizio'; selWrap.appendChild(lab);

    const select=document.createElement('select'); select.id=`sel_${phase.key}`; select.disabled=!presenti;
    if(presenti){
      const opts=optionsForPhase(phase.key, presenti); optionsCache[phase.key]=opts.map(o=>o.id);
      const placeholder=document.createElement('option'); placeholder.value=''; placeholder.textContent='— Seleziona —'; placeholder.disabled=true; placeholder.selected=!selections[phase.key];
      select.appendChild(placeholder);
      for(const ex of opts){ const o=document.createElement('option'); o.value=ex.id; o.textContent=ex.name; select.appendChild(o); }
      if(selections[phase.key] && opts.find(o=>o.id===selections[phase.key])) select.value=selections[phase.key];
    }else{
      const o=document.createElement('option'); o.value=''; o.textContent='— Imposta i presenti —'; select.appendChild(o);
    }
    selWrap.appendChild(select);

    const meta=document.createElement('div'); meta.className='meta'; meta.id=`meta_${phase.key}`;
    meta.textContent='Descrizione e materiale appariranno qui.';
    selWrap.appendChild(meta);

    wrap.appendChild(selWrap); container.appendChild(wrap);

    select.addEventListener('change', e=>{
      const id=e.target.value||null; selections[phase.key]=id; updatePhaseDetails(phase.key,id); updateTotalsUI();
    });

    if(selections[phase.key]) updatePhaseDetails(phase.key, selections[phase.key]);
  }
}
function updatePhaseDetails(phaseKey,id){
  const meta=document.getElementById(`meta_${phaseKey}`); const presenti=getPresenti()||0;
  if(!id){ meta.innerHTML='— (non selezionato) —'; return; }
  const ex=getExerciseById(phaseKey,id); if(!ex){ meta.innerHTML='— (non disponibile) —'; return; }
  const mats=prettyMaterialList(ex.mats||{},presenti);
  meta.innerHTML = `
    <table class="meta">
      <tr><td><span class="k">Esercizio</span></td><td>${ex.name}</td></tr>
      <tr><td><span class="k">Descrizione</span></td><td>${ex.desc}</td></tr>
      <tr><td><span class="k">Materiale</span></td><td>${mats || '—'}</td></tr>
    </table>
  `;
}

/* ======== MATERIALI TOTALI UI ======== */
function updateTotalsUI(){
  const presenti=getPresenti(); const chips=document.getElementById('totaleChips'); const empty=document.getElementById('totaleEmpty');
  chips.innerHTML=''; if(!presenti){ empty.style.display='block'; return; }
  const tot=aggregateMaterials(selections, presenti); const keys=MAT_ORDER.filter(k=>tot[k]>0);
  if(keys.length===0){ empty.style.display='block'; return; }
  empty.style.display='none';
  if(tot.palloni){ const c=document.createElement('span'); c.className='chip'; c.textContent=`Palloni: ${tot.palloni}`; chips.appendChild(c); }
  for(const k of MAT_ORDER){ if(k==='palloni') continue; const v=tot[k]; if(v>0){ const c=document.createElement('span'); c.className='chip ghost'; c.textContent=`${labelFor(k)}: ${v}`; chips.appendChild(c); } }
}

/* ======== AZIONI UI ======== */
function suggestAll(){
  const presenti=getPresenti(); if(!presenti){ alert('Imposta il numero di presenti (4–20) prima.'); return; }
  for(const phase of PHASES){
    const selEl=document.getElementById(`sel_${phase.key}`); if(!selEl || selEl.disabled) continue;
    const first=[...selEl.options].find(o=>o.value); if(first){ selEl.value=first.value; selections[phase.key]=first.value; updatePhaseDetails(phase.key,first.value); }
  }
  updateTotalsUI();
}
function clearAll(){ selections={}; renderPhases(); updateTotalsUI(); }

/* ======== PDF: TABLE-STYLE SUMMARY ======== */
function buildSimplePDF(lines){
  const W=595.28, H=841.89, M=36; const body=11, title=16, leading=13;
  let y=H - M - title;
  const esc=s=>asciiSafe(s);
  let content='';
  // Title
  const ttl=esc(lines[0]||'Mister 2.0 - Scheda Allenamento');
  content += `BT /F1 ${title} Tf 1 0 0 1 ${M} ${y.toFixed(2)} Tm (${ttl}) Tj ET\n`;
  y -= (leading+4);
  // Body with setleading (TL)
  content += `BT /F1 ${body} Tf ${M} ${y.toFixed(2)} Td 0 -${leading} Td `;
  let first=true;
  for(let i=1;i<lines.length;i++){
    const t = `(${esc(lines[i])}) Tj`;
    if(first){ content += t; first=false; } else { content += ' T* ' + t; }
  }
  content += ' ET\n';

  const encoder=new TextEncoder();
  const header='%PDF-1.4\n%\xE2\xE3\xCF\xD3\n';
  const objs=[];
  objs.push('1 0 obj\n<< /Type /Catalog /Pages 2 0 R >>\nendobj\n');
  objs.push('2 0 obj\n<< /Type /Pages /Kids [3 0 R] /Count 1 >>\nendobj\n');
  objs.push(`3 0 obj
<< /Type /Page /Parent 2 0 R /MediaBox [0 0 ${W.toFixed(2)} ${H.toFixed(2)}]
/Resources << /Font << /F1 4 0 R >> >>
/Contents 5 0 R >>
endobj
`);
  objs.push('4 0 obj\n<< /Type /Font /Subtype /Type1 /BaseFont /Helvetica >>\nendobj\n');
  const contentBytes=encoder.encode(content);
  objs.push(`5 0 obj
<< /Length ${contentBytes.length} >>
stream
${content}
endstream
endobj
`);
  let offset=encoder.encode(header).length; const offsets=[0]; const parts=[];
  for(const o of objs){ offsets.push(offset); parts.push(o); offset += encoder.encode(o).length; }
  const xrefStart=offset;
  let xref=`xref\n0 ${objs.length+1}\n0000000000 65535 f \n`;
  for(let i=1;i<=objs.length;i++){ xref += String(offsets[i]).padStart(10,'0') + ' 00000 n \n'; }
  const trailer=`trailer\n<< /Size ${objs.length+1} /Root 1 0 R >>\nstartxref\n${xrefStart}\n%%EOF`;
  const pdfString = header + parts.join('') + xref + trailer;
  return new Blob([encoder.encode(pdfString)], {type:'application/pdf'});
}

/* ======== COSTRUZIONE RIGHE "TABELLARI" ======== */
function buildTableLines(meta, rows, totAggregato){
  const lines=[];
  lines.push('Mister 2.0 — Scheda Allenamento (Tabella riepilogativa)');
  const r1=`Data: ${meta.data || '—'}   Ora: ${meta.ora || '—'}   Giorno: ${weekdayOf(meta.data)}   Campo: ${meta.campo || '—'}`;
  const r2=`Categoria: ${meta.categoria}   Mister: ${meta.mister || '—'}   Presenti: ${meta.presenti}`;
  lines.push(...wrapText(r1, 95));
  lines.push(...wrapText(r2, 95));
  if(meta.note) lines.push(...wrapText(`Note: ${meta.note}`, 95));
  lines.push('');

  // Header tabella (colonne compatte)
  // Colonne: Fase(2) | Finestra(9) | Dur(3) | Esercizio(26) | Materiale(45)
  const H1 = padRight('F#',2), H2=padRight('Finestra',9), H3=padRight('Dur',3), H4=padRight('Esercizio',26), H5=padRight('Materiale',45);
  lines.push(`${H1}  ${H2}  ${H3}  ${H4}  ${H5}`);
  lines.push(''.padEnd(2,'=')+'  '+''.padEnd(9,'=')+'  '+''.padEnd(3,'=')+'  '+''.padEnd(26,'=')+'  '+''.padEnd(45,'='));

  // Righe
  for(const r of rows){
    // wrap esercizio e materiale sulle rispettive larghezze
    const exLines = wrapText(r.esercizio || '— (non selezionato) —', 26);
    const matLines = wrapText(r.materiale || '—', 45);
    const maxL = Math.max(1, exLines.length, matLines.length);
    for(let i=0;i<maxL;i++){
      const left = i===0 ? padRight(String(r.n),2) : '  ';
      const win  = i===0 ? padRight(r.finestra,9) : ''.padEnd(9,' ');
      const dur  = i===0 ? padRight(String(r.durata),3) : ''.padEnd(3,' ');
      const ex   = padRight(exLines[i]||'',26);
      const mat  = padRight(matLines[i]||'',45);
      lines.push(`${left}  ${win}  ${dur}  ${ex}  ${mat}`);
    }
  }

  lines.push('');
  lines.push('Materiale totale (palloni = massimo per fase):');
  lines.push(...wrapText(totAggregato || '—', 95));
  return lines;
}
function weekdayOf(iso){
  if(!iso) return '—';
  const d=new Date(iso+'T00:00:00'); const w=['Domenica','Lunedì','Martedì','Mercoledì','Giovedì','Venerdì','Sabato'];
  return w[d.getDay()]||'';
}

/* ======== EXPORT & SHARE ======== */
function exportPDF(){
  const meta=collectMeta();
  if(!meta.presenti){ alert('Inserisci il numero di presenti.'); return; }

  const rows=[];
  PHASES.forEach((phase, idx)=>{
    const id=selections[phase.key];
    if(!id){ rows.push({ n:idx+1, finestra:phase.window, durata:phase.duration, esercizio:'— (non selezionato) —', materiale:'—' }); return; }
    const ex=getExerciseById(phase.key,id);
    const mats=prettyMaterialList(ex.mats||{}, meta.presenti);
    rows.push({ n:idx+1, finestra:phase.window, durata:phase.duration, esercizio:ex.name, materiale:mats||'—' });
  });

  const tot = aggregateMaterials(selections, meta.presenti);
  const totLine = aggregateTotalsForPrint(tot) || '—';

  const lines = buildTableLines(meta, rows, totLine);
  const blob = buildSimplePDF(lines);
  lastPdfBlob = blob;

  const safeDate = (meta.data||new Date().toISOString().slice(0,10));
  const safeCat = meta.categoria.replace(/\s+/g,'');
  const filename = `Mister20_${safeDate}_${safeCat}_${meta.presenti}p.pdf`;
  lastPdfFilename = filename;

  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=filename;
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
}

async function shareWhatsApp(){
  const meta=collectMeta();
  if(!lastPdfBlob){ // se non ancora creato, crealo prima
    exportPDF();
  }
  if(!lastPdfBlob){ alert('Impossibile generare il PDF.'); return; }

  const file = new File([lastPdfBlob], lastPdfFilename || 'Mister20.pdf', {type:'application/pdf'});

  // Web Share API (con file). Se disponibile, condivide direttamente (in molte app mobile apre anche WhatsApp)
  if(navigator.canShare && navigator.canShare({ files:[file] })){
    try{
      await navigator.share({
        title:'Mister 2.0 – Scheda Allenamento',
        text:`Piano allenamento (${meta.data||''} ${meta.ora||''}) – ${meta.categoria} – Presenti: ${meta.presenti || '—'}`,
        files:[file]
      });
      return;
    }catch(e){ /* utente ha annullato o share non riuscita: fallback in basso */ }
  }

  // Fallback: prepara testo e apre WhatsApp Web con messaggio precompilato (l'utente potrà allegare manualmente il PDF scaricato)
  const msg = `Piano allenamento Mister 2.0\nData: ${meta.data||'—'} Ore: ${meta.ora||'—'}\nCampo: ${meta.campo||'—'}\nCategoria: ${meta.categoria}\nPresenti: ${meta.presenti||'—'}\n(Allego PDF della scheda)`;
  const url = `https://wa.me/?text=${encodeURIComponent(msg)}`;
  window.open(url, '_blank');
}

/* ======== BIND & BOOT ======== */
function bind(){
  document.getElementById('presenti').addEventListener('input', ()=>{
    const v=getPresenti(); const el=document.getElementById('presenti'); if(v!==null) el.value=v;
    for(const k of Object.keys(selections)){
      const id=selections[k]; if(!id) continue;
      const ex=getExerciseById(k,id); if(!ex) { selections[k]=null; continue; }
      if(!(ex.min<=v && v<=ex.max)) selections[k]=null;
    }
    renderPhases(); updateTotalsUI();
  });
  document.getElementById('btnSuggest').addEventListener('click', suggestAll);
  document.getElementById('btnClear').addEventListener('click', clearAll);
  document.getElementById('btnSave').addEventListener('click', saveState);
  document.getElementById('btnLoad').addEventListener('click', loadState);
  document.getElementById('btnPdf').addEventListener('click', exportPDF);
  document.getElementById('btnShareWA').addEventListener('click', shareWhatsApp);

  const year=new Date().getFullYear();
  document.getElementById('footer').textContent = `© ${year} Mister 2.0 – Planner Allenamenti · by 2M Digital Consulting srls`;
  document.getElementById('data').value = new Date().toISOString().slice(0,10);

  renderPhases(); updateTotalsUI();
}
document.addEventListener('DOMContentLoaded', bind);
</script>
</body>
</html>
